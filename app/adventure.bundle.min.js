function scrollByX(n,t){var i=parseInt(n.css("top"),10);n.css("top",i+t+"px")}var Button={Button:function(n){var t,u,i,r;if(typeof n.cooldown=="number"&&(this.data_cooldown=n.cooldown),this.data_remaining=0,typeof n.click=="function"&&(this.data_handler=n.click),t=$("<div>").attr("id",typeof n.id!="undefined"?n.id:"BTN_"+Engine.getGuid()).addClass("button").text(typeof n.text!="undefind"?n.text:"button").click(function(){$(this).hasClass("disabled")||(Button.cooldown($(this)),$(this).data("handler")($(this)))}).data("handler",typeof n.click=="function"?n.click:function(){Engine.log("click")}).data("remaining",0).data("cooldown",typeof n.cooldown=="number"?n.cooldown:0),t.append($("<div>").addClass("cooldown")),Button.cooldown(t,"state"),n.cost){u=n.ttPos?n.ttPos:"buttom right";i=$("<div>").addClass("tooltip"+u);for(r in n.cost)$("<div>").addClass("row_key").text(r).appendTo(i),$("<div>").addClass("row_val").text(n.cost[r]).appendTo(i);i.children().length>0&&i.appendTo(t)}return n.width&&t.css("width",n.width),t},saveCooldown:!0,setDisabled:function(n,t){n&&(t||n.data("onCooldown")?t&&n.addClass("disabled"):n.removeClass("disabled"),n.data("disabled",t))},isDisabled:function(n){return n?n.data("disabled")===!0:!1},cooldown:function(n,t){var u=n.data("cooldown"),i="cooldown."+n.attr("id"),r,f,e;if(u>0){switch(t){case"state":if(!$SM.get(i))return;r=Math.min($SM.get(i),u);f=(r/u).toFixed(4);break;default:r=u;f=1}Button.clearCooldown(n);Button.saveCooldown&&($SM.set(i,r),n.data("countdown",Engine.setInterval(function(){$SM.set(i,$SM.get(i,!0)-.5,!0)},500)));e=r;Engine.options.doubleTime&&(e/=2);$("div.cooldown",n).width(f*100+"%").animate({width:"0%"},e*1e3,"linear",function(){Button.clearCooldown(n,!0)});n.addClass("disabled");n.data("onCooldown",!0)}},clearCooldown:function(n,t){var t=t||!1;t||$("div.cooldown",n).stop(!0,!0);n.data("onCooldown",!1);n.data("countdown")&&(window.clearInterval(n.data("countdown")),$SM.remove("cooldown."+n.attr("id")),n.removeData("countdown"));n.data("disabled")||n.removeClass("disabled")}},Commands={CHEAT_MODE:!1,CHEAT_MODE_COMMAND:"toggle debug",CLEAR_NEXT:!1,LAST_COMMAND:"",options:{},init:function(n){this.options=$.extend(this.options,n);$.Dispatch("stateUpdate").subscribe(Events.handleStateUpdates)},trigger:function(n){var t,i,r,f,e,u;if(Notifications.CLEAR_NEXT&&Notifications.clear(),Notifications.LAST_COMMAND=n,Notifications.notify("> "+n),Story.options.inCommandEvent)return Story.options.commandEventCallback(n);if(t=Room.getRoom(Story.activeRoom),t&&t.commands&&t.commands.length>0)for(i in t.commands){r=t.commands[i][0];f=t.commands[i][1];for(e in r)if(n==r[e])return f()}if(n==Commands.CHEAT_MODE_COMMAND){if(Commands.CHEAT_MODE){Commands.CHEAT_MODE=!1;Engine.options.debug=!1;Engine.options.log=!1;Notifications.notify("Debug Mode Deactive");return}Commands.CHEAT_MODE=!0;Engine.options.debug=!0;Engine.options.log=!0;Notifications.notify("Debug Mode Active");return}if(!Commands.CHEAT_MODE||!Commands.triggerCheatCommands(n)){u=n.split(" ");switch(u[0]){case"go":case"walk":return Commands.triggerGo(u);case"north":case"n":return Commands.triggerGo("north");case"south":case"s":return Commands.triggerGo("south");case"east":case"e":return Commands.triggerGo("east");case"west":case"w":return Commands.triggerGo("west");case"look":return Commands.triggerLook(n);case"use":return Commands.triggerUse(n);case"eat":return Commands.triggerEat(n);default:return Commands.triggerInvalidCommand()}}},triggerCheatCommands:function(n){switch(n){case"heal":return Player.setHp(Player.getMaxHealth()),!0;case"trigger fight":return Events.triggerFight(),!0;case"trigger event":return Events.triggerEvent(),!0;case"trigger room event":var t=Room.getRoom(Story.activeRoom);if(t)return Events.triggerRoomEvent(t.Events),!0;break;case"give item":return Notifications.notify("What Item do you want ?"),Story.options.inCommandEvent=!0,Story.options.commandEventCallback=function(){Story.options.inCommandEvent=!1},!0}return!1},triggerInvalidCommand:function(){Notifications.notify("Invalid Command.")},triggerUse:function(n){var i=n.replace("use ",""),t=Items.getUnknownItem(i);t!=null&&Player.useItem(t)},triggerEat:function(n){var i=n.replace("eat ",""),t=Items.getUnknownItem(i);t!=null&&Player.eatFood(t)},triggerGo:function(n){if(Array.isArray(n)){if(n.length==1){Notifications.notify("Go Where?");return}Commands.triggerGo(n[1])}else Story.go(n)},triggerLook:function(n){var r=n.split(" "),i,t;r[1]=="at"?(i=n.replace("look at ",""),t=Items.getUnknownItem(i),t!=null?Player.lookAtItem(t):Notifications.notify("No such item.")):Story.look()},handleStateUpdates:function(){}};(function(){function t(n){return $(n.target).hasClass("menuBtn")}function i(){return!0}var n=window.Engine={VERSION:1,GAME_STARTED:!1,GAME_OVER:!1,SAVE_DISPLAY:3e4,options:{state:null,debug:!1,log:!1},ui:{roomPanel:!1,playerPanel:!0},topics:{},init:function(t){if(n.GAME_STARTED=$SM.get("game.started",!0),!n.GAME_STARTED){this.options=$.extend(this.options,t);this._debug=this.options.debug;this._log=this.options.log;!n.browserValid();n.isMobile();this.options.state!=null?window.State=this.options.state:n.loadGame();var i=$("<div>").addClass("gameMenu").appendTo("#gameFooter");$("<span>").addClass("menuBtn").text("restart.").click(n.confirmDelete).appendTo(i);$("<span>").addClass("menuBtn").text("save.").click(n.exportImport).appendTo(i);$("#commandTxt").on("keypress",n.keyPress);$.Dispatch("stateUpdate").subscribe(n.handleStateUpdates);$SM.init();Notifications.init();Items.init();Room.init();Player.init();Events.init();Story.init();n.GAME_STARTED=!0;$SM.set("game.started",n.GAME_STARTED);n.updateUI();n.autoFocus()}},browserValid:function(){return location.search.indexOf("ignorebrowser=true")>=0||typeof Storage!="undefined"&&!oldIE},isMobile:function(){return location.search.indexOf("ignorebrowser=true")<0&&/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)},updateUI:function(){var t=$SM.get("game.compass");t==undefined&&(t=!1);n.ui.roomPanel=t;Player.checkUISettings();Story.checkUISettings()},saveGame:function(){typeof Storage!="undefined"&&localStorage&&(n._saveTimer!=null&&clearTimeout(n._saveTimer),(typeof n._lastNotify=="undefined"||Date.now()-n._lastNotify>n.SAVE_DISPLAY)&&($("#saveNotify").css("opacity",1).animate({opacity:0},1e3,"linear"),n._lastNotify=Date.now()),localStorage.gameState=JSON.stringify(State))},loadGame:function(){try{var t=JSON.parse(localStorage.gameState);t&&(State=t,$SM.updateOldState(),n.log("loaded save!"))}catch(i){State={};$SM.set("version",n.VERSION);n.event("progress","new game")}},exportImport:function(){Events.startEvent({title:"Export / Import",scenes:{start:{text:["export or import save data, for backing up","or migrating computers"],buttons:{"export":{text:"export",nextScene:{1:"inputExport"}},"import":{text:"import",nextScene:{1:"confirm"}},cancel:{text:"cancel",nextScene:"end"}}},inputExport:{text:["save this."],textarea:n.export64(),onLoad:function(){n.event("progress","export")},readonly:!0,buttons:{done:{text:"got it",nextScene:"end",onChoose:n.disableSelection}}},confirm:{text:["are you sure?","if the code is invalid, all data will be lost.","this is irreversible."],buttons:{yes:{text:"yes",nextScene:{1:"inputImport"},onChoose:n.enableSelection},no:{text:"no",nextScene:{1:"start"}}}},inputImport:{text:["put the save code here."],textarea:"",buttons:{okay:{text:"import",nextScene:"end",onChoose:n.import64},cancel:{text:"cancel",nextScene:"end"}}}}})},generateExport64:function(){var n=Base64.encode(localStorage.gameState);return n=n.replace(/\s/g,""),n=n.replace(/\./g,""),n.replace(/\n/g,"")},export64:function(){return n.saveGame(),n.enableSelection(),n.generateExport64()},import64:function(t){n.event("progress","import");n.disableSelection();t=t.replace(/\s/g,"");t=t.replace(/\./g,"");t=t.replace(/\n/g,"");var i=Base64.decode(t);localStorage.gameState=i;location.reload()},event:function(n,t){typeof ga=="function"&&ga("send","event",n,t)},confirmDelete:function(){Events.startEvent({title:"Restart?",scenes:{start:{text:["restart the game?"],buttons:{yes:{text:"yes",nextScene:"end",onChoose:n.deleteSave},no:{text:"no",nextScene:"end"}}}}})},deleteSave:function(t){n.GAME_OVER=!1;typeof Storage!="undefined"&&localStorage&&(window.State={},localStorage.clear());t||location.reload()},endGame:function(){n.deleteSave(!0)},getGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=Math.random()*16|0,i=n=="x"?t:t&3|8;return i.toString(16)})},log:function(n){this._log&&console.log(n)},keyLock:!1,keyPress:function(t){if(t.which===13){if(t.preventDefault(),!n.keyLock&&!n.GAME_OVER){var i=$("#commandTxt").val().toLowerCase();Commands.trigger(i)}$("#commandTxt").val("")}},disableSelection:function(){document.onselectstart=t;document.onmousedown=t},enableSelection:function(){document.onselectstart=i;document.onmousedown=i},autoSelect:function(n){$(n).focus().select()},autoFocus:function(n){if(n==undefined)return $("#commandTxt").focus();$(n).focus()},handleStateUpdates:function(t){t.category=="game"&&t.stateName.indexOf("game.compass")===0&&n.updateUI()},setInterval:function(t,i,r){return n.options.doubleTime&&!r&&(n.log("Double time, cutting interval in half"),i/=2),setInterval(t,i)},setTimeout:function(t,i,r){return n.options.doubleTime&&!r&&(n.log("Double time, cutting timeout in half"),i/=2),setTimeout(t,i)}}})();$.Dispatch=function(n){var t,i=n&&Engine.topics[n];return i||(t=jQuery.Callbacks(),i={publish:t.fire,subscribe:t.add,unsubscribe:t.remove},n&&(Engine.topics[n]=i)),i};$(document).ready(function(){$("#startGameBtn").click(function(){$("#devGameModal").modal("show");Engine.init()})});var Events={_EVENT_TIME_RANGE:[3,6],_PANEL_FADE:200,_FLIGHT_SPEED:100,_MEDS_COOLDOWN:7,_LEAVE_COOLDOWN:1,STUN_DURATION:4e3,init:function(n){this.options=$.extend(this.options,n);Events.EventPool=[].concat(Events.Global,Events.Story);Events.eventStack=[];Events.scheduleNextEvent();$.Dispatch("stateUpdate").subscribe(Events.handleStateUpdates);Events.initDelay()},options:{},delayState:"wait",activeScene:null,updateEventPool:function(){Events.EventPool=[].concat(Events.Global,Events.Story)},activeEvent:function(){return Events.eventStack&&Events.eventStack.length>0?Events.eventStack[0]:null},eventPanel:function(){return Events.activeEvent().eventPanel},loadScene:function(n){if(n=="end")return Events.endEvent();Engine.log("loading scene: "+n);Events.activeScene=n;var t=Events.activeEvent().scenes[n];t.onLoad&&t.onLoad();t.notification&&Notifications.notify(t.notification);t.reward&&$SM.addM("inventory",t.reward);$("#eventDescription",Events.eventPanel()).empty();$("#eventButtons",Events.eventPanel()).empty();t.combat?Events.startCombat(t):Events.startStory(t)},startStory:function(n){var t=$("#eventDescription",Events.eventPanel()),u=!1,i,r;for(i in n.text)$("<div>").text(n.text[i]).appendTo(t);n.textarea!=null&&(r=$("<textarea>").val(n.textarea).appendTo(t),n.readonly&&r.attr("readonly",!0),Engine.autoSelect("#eventDescription textarea"));n.loot&&Events.drawLoot(n.loot);u=Events.drawButtons(n)},startCombat:function(n){var e,u,i,r,t,f,o;Engine.event("game event","combat");Events.won=!1;e=$("#eventDescription",Events.eventPanel());$("<div>").text(n.notification).appendTo(e);Events.createCombatPanel(e,n);u=$("#eventButtons",Events.eventPanel());i=0;for(r in Items.Weapons)if(t=Items.Weapons[r],typeof Player.inventory[r]=="number"&&Player.inventory[r]>0){if(typeof t.damage!="number"||t.damage===0)i--;else if(t.cost)for(f in t.cost)o=t.cost[f],(typeof Player.inventory[f]!="number"||Player.inventory[f]<o)&&i--;i++;Events.createAttackButton(r).appendTo(u)}i===0&&Events.createAttackButton("fists").prependTo(u);(Player.inventory.medicine||0)!==0&&Events.createUseMedsButton().appendTo(u);Events._enemyAttackTimer=Engine.setTimeout(Events.enemyAttack,n.attackDelay*1e3)},createUseMedsButton:function(n){n==null&&(n=Events._MEDS_COOLDOWN);var t=new Button.Button({id:"meds",text:"use meds",cooldown:n,click:Events.useMeds,cost:{medicine:1}});return(Player.inventory.medicine||0)===0&&Button.setDisabled(t,!0),t},createAttackButton:function(n){var t=Items.Weapons[n],u=t.cooldown,i,r;t.type=="unarmed"&&$SM.hasPerk("martial artist")&&(u/=2);i=new Button.Button({id:"attack_"+n.replace(" ","-"),text:t.verb,cooldown:u,click:Events.useWeapon,cost:t.cost});typeof t.damage=="number"&&t.damage>0&&i.addClass("weaponButton");for(r in t.cost)if(typeof Player.inventory[r]!="number"||Player.inventory[r]<t.cost[r]){Button.setDisabled(i,!0);break}return i},drawFloatText:function(n,t){$("<div>").text(n).addClass("damageText").appendTo(t).animate({bottom:"100px",opacity:"0"},300,"linear",function(){$(this).remove()})},useMeds:function(){var n,t,i;Player.inventory.medicine&&(Player.inventory.medicine--,Player.updateInventory(),Player.inventory.medicine===0&&Button.setDisabled($("#meds"),!0),n=Player.health,n+=Player.medsHeal(),n=n>Player.getMaxHealth()?Player.getMaxHealth():n,Player.setHp(n),Events.activeEvent()&&(t=$("#gamePlayerStats"),t.data("hp",n),Events.updateFighterDiv(t),Events.drawFloatText("+"+Player.medsHeal(),"#gamePlayer"),i=Events.setTakeAll(),Events.canLeave(i)))},useWeapon:function(n){var s,t,u,f,i,e,o,r,h;if(Events.activeEvent()){if(s=n.attr("id").substring(7).replace("-"," "),t=Items.Weapons[s],t.type=="unarmed"&&($SM.get("player.punches")||$SM.set("player.punches",0),$SM.add("player.punches",1),$SM.get("player.punches")!=50||$SM.hasPerk("boxer")?$SM.get("player.punches")!=150||$SM.hasPerk("martial artist")||$SM.addPerk("martial artist"):$SM.addPerk("boxer")),t.cost){u={};f=!1;for(i in t.cost){if(typeof Player.inventory[i]!="number"||Player.inventory[i]<t.cost[i])return;u[i]=-t.cost[i];Player.inventory[i]-t.cost[i]<t.cost[i]&&(f=!0)}for(i in u)Player.inventory[i]+=u[i];f&&(Button.setDisabled(n,!0),e=!1,$(".weaponButton").each(function(){if(!Button.isDisabled($(this))&&$(this).attr("id")!="attack_fists")return e=!0,!1}),e||(o=$("#attack_fists"),o.length===0?Events.createAttackButton("fists").prependTo("#buttons",Events.eventPanel()):Button.setDisabled(o,!1)));Player.updateInventory()}r=-1;Math.random()<=Player.getHitChance()&&(r=t.damage,typeof r=="number"&&(t.type=="unarmed"&&$SM.hasPerk("boxer")&&(r*=2),t.type=="unarmed"&&$SM.hasPerk("martial artist")&&(r*=3)));h=t.type=="ranged"?Events.animateRanged:Events.animateMelee;h($("#gamePlayer"),r,function(){$("#gameEnemyStats").data("hp")<=0&&!Events.won&&Events.winFight()})}},animateMelee:function(n,t,i){var u,f,r,e;n.attr("id")=="gamePlayer"?(u={left:"50%"},f={left:"25%"},r=$("#gameEnemyStats"),e=$("#gameEnemy")):(u={right:"50%"},f={right:"25%"},r=$("#gamePlayerStats"),e=$("#gamePlayer"));n.stop(!0,!0).animate(u,Events._FIGHT_SPEED,function(){var u=r.data("hp"),o="";typeof t=="number"?t<0?(o="miss",t=0):(o="-"+t,u=u-t<0?0:u-t,r.data("hp",u),n.attr("id")=="gameEnemy"&&Player.setHp(u),Events.updateFighterDiv(r)):t=="stun"&&(o="stunned",r.data("stunned",!0),Engine.setTimeout(function(){r.data("stunned",!1)},Events.STUN_DURATION));Events.drawFloatText(o,e);$(this).animate(f,Events._FIGHT_SPEED,i)})},animateRanged:function(n,t,i){var u,f,r,e;n.attr("id")=="gamePlayer"?(u={left:"25%"},f={left:"50%"},r=$("#gameEnemyStats"),e=$("#gameEnemy")):(u={right:"25%"},f={right:"50%"},r=$("#gamePlayerStats"),e=$("#gamePlayer"));$("<div>").css(u).addClass("bullet").text("o").appendTo("#fightersPanel").animate(f,Events._FIGHT_SPEED,"linear",function(){var u=r.data("hp"),f="";typeof t=="number"?t<0?(f="miss",t=0):(f="-"+t,u=u-t<0?0:u-t,r.data("hp",u),n.attr("id")=="gameEnemy"&&Player.setHp(u),Events.updateFighterDiv(r)):t=="stun"&&(f="stunned",r.data("stunned",!0),Engine.setTimeout(function(){r.data("stunned",!1)},Events.STUN_DURATION));Events.drawFloatText(f,e);$(this).remove();typeof i=="function"&&i()})},enemyAttack:function(){var n,t,i,r;Events.activeEvent()!=null&&(n=Events.activeEvent().scenes[Events.activeScene],$("#gameEnemyStats").data("stunned")||(t=n.hit,t*=$SM.hasPerk("evasive")?.8:1,i=-1,Math.random()<=t&&(i=n.damage),r=n.ranged?Events.animateRanged:Events.animateMelee,r($("#gameEnemy"),i,function(){$("#gamePlayerStats").data("hp")<=0&&(clearTimeout(Events._enemyAttackTimer),Events.endEvent(),Player.die())})),Events._enemyAttackTimer=Engine.setTimeout(Events.enemyAttack,n.attackDelay*1e3))},winFight:function(){Events.won=!0;clearTimeout(Events._enemyAttackTimer);$("#gameEnemy").animate({opacity:0},300,"linear",function(){Engine.setTimeout(function(){try{var n=Events.activeEvent().scenes[Events.activeScene],t=!1,r=$("#eventDescription",Events.eventPanel()),i=$("#eventButtons",Events.eventPanel());r.empty();i.empty();$("<div>").text(n.deathMessage).appendTo(r);Events.drawLoot(n.loot);n.buttons?t=Events.drawButtons(n):(t=new Button.Button({id:"leaveBtn",cooldown:Events._LEAVE_COOLDOWN,click:function(){n.nextScene&&n.nextScene!="end"?Events.loadScene(n.nextScene):Events.endEvent()},text:"leave"}),Button.cooldown(t.appendTo(i)),(Player.inventory.medicine||0)!==0&&Events.createUseMedsButton(0).appendTo(i))}catch(u){}},1e3,!0)})},drawLoot:function(n){var f=$("#eventDescription",Events.eventPanel()),e=$("<div>").attr("id","eventLootDrops").text("Loot:").appendTo(f),i,t,r,u;for(i in n)t=n[i],Math.random()<t.chance&&(r=Math.floor(Math.random()*(t.max-t.min))+t.min,u=Events.drawLootRow(i,r),u.appendTo(e),Events.takeLoot(i,r))},drawLootRow:function(n,t){var i=Items.getUnknownItem(n),r=$("<div>").addClass("eventLootRow").data("item",i.name);return $("<span>").text(i.name+" ["+t+"]").appendTo(r),r},takeLoot:function(n,t){$SM.add('inventory["'+n+'"]',t)},createCombatPanel:function(n,t){var i=$("<div>").attr("id","combatPanel").appendTo(n),r;Events.createFighterStatsDiv("Player",Player.health,Player.getMaxHealth()).attr("id","gamePlayerStats").appendTo(i);r=$("<div>").attr("id","fightersPanel").appendTo(i);Events.createFighterDiv("Player").attr("id","gamePlayer").appendTo(r);Events.createFighterDiv(t.enemyName).attr("id","gameEnemy").appendTo(r);Events.createFighterStatsDiv(t.enemyName,t.health,t.health).attr("id","gameEnemyStats").appendTo(i)},createFighterDiv:function(n){return $("<div>").addClass("fighter").html("<i class='fa fa-male fa-3x'><\/i><br />"+n)},createFighterStatsDiv:function(n,t,i){var r=$("<div>").addClass("fighterStats").data("hp",t).data("maxHp",i).data("refname",n),u;return $("<span>").addClass("fighterStatsName").text(n).appendTo(r),u=$("<div>").addClass("hp").text(t+"/"+i).appendTo(r),$("<div>").addClass("clear").appendTo(u),Player.createHPHearts(t,u),r},updateFighterDiv:function(n){var t=$(".hp",n).text(n.data("hp")+"/"+n.data("maxHp"));$("<div>").addClass("clear").appendTo(t);Player.createHPHearts(n.data("hp"),t)},drawButtons:function(n){var f=$("#eventButtons",Events.eventPanel()),r=[],u,t,i;for(u in n.buttons)t=n.buttons[u],i=new Button.Button({id:u,text:t.text,cost:t.cost,click:Events.buttonClick,cooldown:t.cooldown}).appendTo(f),typeof t.available!="function"||t.available()||Button.setDisabled(i,!0),typeof t.cooldown=="number"&&Button.cooldown(i),r.push(i);return Events.updateButtons(),r.length==1?r[0]:!1},updateButtons:function(){var e=Events.activeEvent().scenes[Events.activeScene].buttons,i,n,r,u,f,t;for(i in e)if(n=e[i],r=$("#"+i,Events.eventPanel()),typeof n.available!="function"||n.available()){if(n.cost){u=!1;for(f in n.cost)if(t=Player.inventory[f],typeof t!="number"&&(t=0),t<n.cost[f]){u=!0;break}Button.setDisabled(r,u)}}else Button.setDisabled(r,!0)},buttonClick:function(n){var t=Events.activeEvent().scenes[Events.activeScene].buttons[n.attr("id")],o={},r,u,e,s,i,f;if(t.cost){for(r in t.cost){if(u=Player.inventory[r],typeof u!="number"&&(u=0),u<t.cost[r])return;o[r]=-t.cost[r]}$SM.addM("inventory",o)}if(typeof t.onChoose=="function"){e=Events.eventPanel().find("textarea");t.onChoose(e.length>0?e.val():null)}if(t.reward&&$SM.addM("inventory",t.reward),Events.updateButtons(),t.notification&&Notifications.notify(t.notification),t.nextScene)if(t.nextScene=="end")Events.endEvent();else{s=Math.random();i=null;for(f in t.nextScene)s<f&&(i==null||f<i)&&(i=f);if(i!=null){Events.loadScene(t.nextScene[i]);return}Engine.log("ERROR: no suitable scene found");Events.endEvent()}},triggerEvent:function(){var n,i,t,r;if(Events.activeEvent()==null){n=[];for(i in Events.EventPool)t=Events.EventPool[i],t!=undefined&&t.isAvailable()&&n.push(t);if(n.length===0){Events.scheduleNextEvent(.5);return}r=Math.floor(Math.random()*n.length);Events.startEvent(n[r])}Events.scheduleNextEvent()},triggerFight:function(){var n=[],i,t,r;for(i in Events.Encounters)t=Events.Encounters[i],t.isAvailable()&&n.push(t);r=Math.floor(Math.random()*n.length);Events.startEvent(n[r])},triggerRoomEvent:function(n){var t,r,i,u;if(Events.activeEvent()==null){t=[];for(r in n)i=n[r],i!=undefined&&i.isAvailable()&&t.push(i);if(t.length===0)return;u=Math.floor(Math.random()*t.length);Events.startEvent(t[u])}},startEvent:function(n,t){if(n){Engine.event("game event","event");Engine.keyLock=!0;Button.saveCooldown=!1;Events.eventStack.unshift(n);n.eventPanel=$("<div>").attr("id","event").addClass("eventPanel").css("opacity","0");t!=null&&t.width!=null&&Events.eventPanel().css("width",t.width);$("<div>").addClass("eventTitle").text(Events.activeEvent().title).appendTo(Events.eventPanel());$("<div>").attr("id","eventDescription").appendTo(Events.eventPanel());$("<div>").attr("id","eventButtons").appendTo(Events.eventPanel());Events.loadScene("start");$("div#gameWrapper").append(Events.eventPanel());Events.eventPanel().animate({opacity:1},Events._PANEL_FADE,"linear");var i=Events.activeEvent().scenes[Events.activeScene]}},scheduleNextEvent:function(n){var t=Math.floor(Math.random()*(Events._EVENT_TIME_RANGE[1]-Events._EVENT_TIME_RANGE[0]))+Events._EVENT_TIME_RANGE[0];n>0&&(t*=n);Engine.log("next event scheduled in "+t+" minutes");Events._eventTimeout=Engine.setTimeout(Events.triggerEvent,t*6e4)},endEvent:function(){Events.eventPanel().animate({opacity:0},Events._PANEL_FADE,"linear",function(){Events.eventPanel().remove();Events.activeEvent().eventPanel=null;Events.eventStack.shift();Engine.log(Events.eventStack.length+" events remaining");Engine.keyLock=!1;Button.saveCooldown=!0;Engine.autoFocus()})},handleStateUpdates:function(n){n.category=="inventory"&&Events.activeEvent()!=null&&Events.updateButtons()},initDelay:function(){$SM.get(Events.delayState)&&Events.recallDelay(Events.delayState,Events)},recallDelay:function(n,t){var r=$SM.get(n);for(var i in r)typeof r[i]=="object"?Events.recallDelay(n+'["'+i+'"]',t[i]):typeof t[i]=="function"?t[i]():$SM.remove(n);$.isEmptyObject(r)&&$SM.remove(n)},saveDelay:function(n,t,i){var r=Events.delayState+"."+t,i,u;i?$SM.set(r,i):i=$SM.get(r,!0);u=Engine.setInterval(function(){$SM.set(r,$SM.get(r)-.5,!0)},500);Engine.setTimeout(function(){window.clearInterval(u);$SM.remove(r);$SM.removeBranch(Events.delayState);n()},i*1e3)}},Items={DEFAULT_WEAPON_DAMAGE:1,DEFAULT_WEAPON_COOLDOWN:2,Weapons:{fists:{id:"fists",name:"Fists",verb:"punch",type:"unarmed",damage:1,cooldown:2},knife:{id:"knife",name:"Knife",verb:"stab",type:"melee",damage:3,cooldown:3},"hand gun":{id:"hand gun",name:"Hand Gun",verb:"shoot",damage:6,cooldown:5,cost:{bullets:1}}},Food:{meat:{id:"meat",name:"Meat",type:"food",heal:2}},Craftables:{torch:{it:"torch",name:"Torch",type:"tool",maximum:10,maxMsg:"You don't need any more",buildMsg:"a torch to keep the dark away",cost:function(){return{wood:1,cloth:1}}}},Ammo:{medicine:{id:"medicine",name:"Medicine",type:"ammo",use:function(){var n=Player.health;return n+=Player.medsHeal(),n=n>Player.getMaxHealth()?Player.getMaxHealth():n,Player.setHp(n),!0}},bullets:{id:"bullets",name:"Bullets",type:"ammo"}},MiscItems:{compass:{id:"compass",name:"Compass",type:"misc",desc:"A golden compass that points to north",roomDesc:"You notice a golden <b>compass<\/b> lying on the floor."}},init:function(n){this.options=$.extend(this.options,n);Items.ItemPool=[];Items.ItemPool.weapon=Items.Weapons;Items.ItemPool.craftable=Items.Craftables;Items.ItemPool.food=Items.Food;Items.ItemPool.ammo=Items.Ammo;Items.ItemPool.misc=Items.MiscItems;$.Dispatch("stateUpdate").subscribe(Items.handleStateUpdates)},options:{},getItem:function(n,t){var i=Items.ItemPool[n];return i[t]},getUnknownItem:function(n){var i,t;for(i in Items.ItemPool)if(t=Items.ItemPool[i],n in t)return t[n];return null},addItem:function(n,t,i){var r={};t&&(r.name=i.name,r.type=i.type!=undefined?i.type:n,r.desc=i.desc,r.roomDesc=i.roomDesc,n=="weapon"?(r.verb=i.verb!=undefined?i.verb:"Use "+r.name,r.damage=typeof i.damage=="number"&&i.damage>0?i.damage:DEFAULT_WEAPON_DAMAGE,r.cooldown=typeof i.cooldown=="number"&&i.cooldown>0?i.cooldown:DEFAULT_WEAPON_COOLDOWN,typeof i.cost=="object"&&(r.cost=i.cost)):n=="craftable"?(r.maximum=i.maximum!=undefined?i.maximum:1,r.availableMsg=i.availableMsg,r.buildMsg=i.buildMsg,r.maxMsg=i.maxMsg!=undefined?i.maxMsg:"You cannot have any more of these."):n=="food"&&(r.heal=i.heal!=undefined?i.heal:1),Items.ItemPool[n][t]=r)},buildItem:function(n){var t=Items.Craftables[n],r,f,u,i,e;if(t!=undefined){r=0;switch(t.type){case"weapons":case"tool":case"upgrade":r=$SM.get('inventory["'+n+'"]',!0)}if(r<0&&(r=0),t.maximum<=r)return;f={};u=t.cost();for(i in u){if(e=$SM.get('inventory["'+i+'"]',!0),e<u[i])return Notifications.nofity("not enough "+i),!1;f[i]=e-u[i]}$SM.setM("inventory",f);Notifications.notify(t.buildMsg);switch(t.type){case"weapons":case"tool":case"upgrade":$SM.add('inventory["'+n+'"]',1)}}},handleStateUpdates:function(){}},Notifications={init:function(n){this.options=$.extend(this.options,n);elem=$("<div>").attr({id:"gameNotifications",className:"notifications"});$("<div>").attr("id","notifyGradient").appendTo(elem);elem.appendTo("#gameMain")},options:{},elem:null,notifyQueue:{},send:function(n){Notifications.notify(n)},notify:function(n,t,i){typeof n!="undefined"&&(t!=null?i||(typeof this.notifyQueue[t]=="undefined"&&(this.notifyQueue[t]=[]),this.notifyQueue[t].push(n)):Notifications.formatMessageAndPrint(n),Engine.saveGame())},clear:function(n){$("#gameNotifications").html("");n&&Notifications.notify("> "+n)},scrollDown:function(){var n=document.getElementById("gameNotifications");n.scrollTop=n.scrollHeight},formatMessageAndPrint:function(n){var t=n.split("[[break]]");for(var i in t)Notifications.printMessage(t[i])},printMessage:function(n){var t=$("<div>").addClass("notification").css("opacity","0").html(n).appendTo("#gameNotifications");t.animate({opacity:1},500,"linear",function(){Notifications.scrollDown()})},printQueue:function(n){if(typeof this.notifyQueue[n]!="undefined")while(this.notifyQueue[n].length>0)Notifications.formatMessageAndPrint(this.notifyQueue[n].shift())}},Player={BASE_HEALTH:10,BASE_HIT_CHANCE:.8,MEDS_HEAL:20,name:"Player",options:{},init:function(n){this.options=$.extend(this.options,n);Player.inventory=$SM.get("inventory");Player.inventory==undefined&&(Player.inventory={});var t=$("<div>").attr("id","gamePlayerStatsPanel").appendTo("#gameMain");Player.updatePlayerPanel();$.Dispatch("stateUpdate").subscribe(Player.handleStateUpdates)},checkUISettings:function(){Engine.ui.roomPanel?$("#gamePlayerStatsPanel").css({top:"calc(20% + 25px)"}):$("#gamePlayerStatsPanel").css({top:"0px"})},updatePlayerPanel:function(){var e,l,o,t,h,i,r,c,u,s,f,n;if($("#gamePlayerStatsPanel").html(""),$("<div>").addClass("gamePanelHeader").text("Player").appendTo("#gamePlayerStatsPanel"),e=$SM.get("player.health"),e==undefined&&(e=Player.getMaxHealth()),Player.setHp(e),l=$("<div>").attr("id","gamePlayerStatsHealthCounter").html("HP: "+Player.health+"/"+Player.getMaxHealth()+" <br />").appendTo("#gamePlayerStatsPanel"),Player.createHPHearts(Player.health,l),$("<div>").addClass("gamePlayerStatsSpacer").text("").appendTo("#gamePlayerStatsPanel"),o=$("<div>").attr("id","gamePlayerStatsPerks").appendTo("#gamePlayerStatsPanel"),$("<div>").addClass("gamePanelHeader").text("Perks").appendTo(o),$SM.get("player.perks"))for(t in $SM.get("player.perks"))h="game_player_perk_"+t.replace(" ","-"),i=$("#"+h),$SM.get('player.perks["'+t+'"]')&&i.length===0&&(i=$("<div>").attr("id",h).addClass("perkRow").appendTo(o),$("<div>").addClass("row_key").text(t).appendTo(i),Story.activeStory&&$("<div>").addClass("tooltip bottom right").text(Story.activeStory.Perks[t].desc).appendTo(i));else $("<span>").addClass("gamePlayerPerkItem").text("None").appendTo(o);$("<div>").addClass("gamePlayerStatsSpacer").text("").appendTo("#gamePlayerStatsPanel");r=$("<div>").attr("id","gamePlayerStatsInventory").appendTo("#gamePlayerStatsPanel");$("<div>").addClass("gamePanelHeader").text("Inventory").appendTo(r);c=0;for(u in Player.inventory){s=Items.getUnknownItem(u);f="";switch(s.type){case"weapon":$SM.get('equipment["'+u+'"]')&&(f="(E) ");break;case"upgrade":f="(U) "}n=$SM.get('inventory["'+u+'"]');(typeof n!="number"||isNaN(n))&&(n=0,$SM.set('inventory["'+u+'"]',0));n>0&&(n>1?$("<div>").addClass("inventoryItem").text(s.name+" "+f+"["+n+"]").appendTo(r):$("<div>").addClass("inventoryItem").text(s.name+" "+f).appendTo(r),c++)}c==0&&$("<div>").addClass("inventoryItem").text("Empty").appendTo(r)},updatePlayerStats:function(){var n=$("#gamePlayerStatsHealthCounter").html("HP: "+Player.health+"/"+Player.getMaxHealth()+" <br />");Player.createHPHearts(Player.health,n)},createHPHearts:function(n,t){if(n==0){$("<i>").text("dead").appendTo(t);return}for(var i=0;i<n;i++)$("<i>").addClass("health").addClass("fa").addClass("fa-heart").appendTo(t)},updateInventory:function(){$SM.setM("inventory",Player.inventory);Player.updatePlayerPanel()},reloadInventory:function(){Player.inventory=$SM.get("inventory");Player.updatePlayerPanel()},setHp:function(n){typeof n!="number"||isNaN(n)||(Player.health=n,Player.health>Player.getMaxHealth()&&(Player.health=Player.getMaxHealth()),$SM.set("player.health",Player.health))},medsHeal:function(){return Player.MEDS_HEAL},useItem:function(n){if(n&&(typeof n=="string"&&(n=Items.getUnknownItem(n)),typeof n=="object"))if(Player.inventory[n.id])if(n.use!=undefined){var t=Player.inventory[n.id],i=n.use();i&&$SM.set('inventory["'+n.id+'"]',t-1)}else Notifications.notify("You cannot use that");else Notifications.notify("You don't have that item")},lookAtItem:function(n){n&&(typeof n=="string"&&(n=Items.getUnknownItem(n)),typeof n=="object"&&(Player.inventory[n.id]?n.desc!=undefined?Notifications.notify(n.desc):Notifications.notify("There is nothing to say about that"):Notifications.notify("You don't have that item to look at")))},eatFood:function(n){if(n)if(typeof n=="string"&&(n=Items.getUnknownItem(n)),typeof n=="object"&&n.type=="food")if(Player.inventory[n.id]){var r=Player.inventory[n.id],t=n.heal!=undefined?n.heal:1,i=Player.getMaxHealth()-Player.health;if(i==0){Notifications.notify("You don't need to heal at full health");return}t>i&&(t=i);$SM.set('inventory["'+n.id+'"]',r-1);Player.setHp(Player.health+t);Notifications.notify("You eat "+n.name+" (heal "+t+" hearts)")}else Notifications.notify("You have no "+n.name+" to eat");else Notifications.notify("You cannot eat that")},pickupItem:function(n,t,i,r){typeof n!="object"&&(n=Items.getUnknownItem(n));t||(t=1);i&&(typeof i!="object"&&(i=Room.getRoom(i)),Room.removeLootFromRoom(i,n));$SM.add('inventory["'+n.id+'"]',t);r||Notifications.notify("You pickup "+t+" "+n.name);Player.updateInventory()},die:function(){Player.dead||(Player.dead=!0,Engine.log("player death"),Engine.event("game event","death"),Engine.keyLock=!0,Notifications.notify("You Died!"),Engine.GAME_OVER=!0,Engine.setTimeout(function(){Engine.endGame()},2e3,!0))},getMaxHealth:function(){return Player.BASE_HEALTH},getHitChance:function(){return $SM.hasPerk("hawkeye")?Player.BASE_HIT_CHANCE+.1:Player.BASE_HIT_CHANCE},handleStateUpdates:function(n){n.category=="player"&&n.stateName.indexOf("player.perks")===0&&Player.updatePlayerStats();n.category=="player"&&n.stateName.indexOf("player.health")===0&&Player.updatePlayerStats();n.category=="inventory"&&Player.reloadInventory()}},Room={ROOMS:[],options:{},init:function(n){this.options=$.extend(this.options,n);$.Dispatch("stateUpdate").subscribe(Room.handleStateUpdates)},reloadRooms:function(){var r=$SM.get("rooms"),t,i,n;if(r)for(t in r)i=r[t],n=Room.ROOMS[t],n.visited=i.visited,n.canEnter=i.canEnter,n.loot=i.loot,Room.ROOMS[t]=n},updateRoomsState:function(){var i=[],t,n;for(t in Room.ROOMS)n=Room.ROOMS[t],i[t]={visited:n.visited,canEnter:n.canEnter,loot:n.loot};$SM.setM("rooms",i)},getRoom:function(n){return Room.ROOMS[n]},createRoom:function(n,t){var i={},r=$SM.get('rooms["'+n+'"]');return i.id=n,i.name=t.name,i.description=t.description,r?(i.visited=r.visited,i.canEnter=r.canEnter,i.loot=r.loot):(i.visited=!1,i.canEnter=t.canEnter!=undefined?t.canEnter:!0,i.loot=typeof t.loot=="object"?t.loot:{}),i.canEnterFunc=typeof t.canEnterFunc=="function"?t.canEnterFunc:function(){},i.lockedDesc=t.lockedDesc!=undefined?t.lockedDesc:"You cannot go that way.",i.commands=typeof t.commands=="object"?t.commands:[],i.Events=typeof t.Events=="object"?t.Events:[],typeof t.onEnter=="function"&&(i.onEnter=t.onEnter),typeof t.onExit=="function"&&(i.onExit=t.onExit),i.exits=typeof t.exits=="object"?t.exits:[],i.triggerEnter=function(){return Room.triggerEnter(this)},i.triggerExit=function(){return Room.triggerExit(this)},i.addExit=function(n,t){return Room.addExit(this,n,t)},i.triggerLook=function(){return Room.triggerLook(this)},Room.ROOMS[n]=i,i},updateRoom:function(n,t){var i=$SM.get('rooms["'+n.id+'"]');t.loot&&(n.loot=t.loot,i.loot=n.loot);t.canEnter&&(n.canEnter=t.canEnter,i.canEnter=n.canEnter);$SM.set('rooms["'+n.id+'"]',i)},visitRoom:function(n){n.visited=!0;var t=$SM.get('rooms["'+n.id+'"]');t.visited=!0;$SM.set('rooms["'+n.id+'"]',t)},addExit:function(n,t,i){n.exits[t]=i;Room.ROOMS[n.id]=n;Room.updateRoomsState()},triggerEnter:function(n){Notifications.notify("<strong>"+n.name+"<\/strong>");n.visited?Room.triggerLootInfo(n):(Room.visitRoom(n),Room.triggerLook(n));n.onEnter&&n.onEnter()},triggerExit:function(n){n.onExit&&n.onExit()},triggerLook:function(n){Notifications.notify(n.description);Room.triggerLootInfo(n)},triggerLootInfo:function(n){var r=n.loot,i,t;for(i in r)t=Items.getUnknownItem(i),t&&t.roomDesc&&Notifications.notify(t.roomDesc)},removeLootFromRoom:function(n,t){delete n.loot[t.id];Room.ROOMS[n.id]=n;Room.updateRoomsState()},handleStateUpdates:function(n){n.category=="rooms"&&Room.reloadRooms()}},StateManager={MAX_STORE:99999999999999,options:{},init:function(n){var t,i;this.options=$.extend(this.options,n);t=["inventory","player","equipment","timers","game","playStats","calldown","story","rooms"];for(i in t)$SM.get(t[i])||$SM.set(t[i],{});$.Dispatch("stateUpdate").subscribe($SM.handleStateUpdates)},createState:function(n,t){for(var r,f,e,u=n.split(/[.\[\]'"]+/),i=0;i<u.length;i++)u[i]===""&&(u.splice(i,1),i--);for(r=State,f=null,i=0,e=u.length-1;i<e;i++)f=u[i],r[f]===undefined&&(r[f]={}),r=r[f];return r[u[i]]=t,r},set:function(n,t,i){var r=$SM.buildPath(n);typeof t=="number"&&t>$SM.MAX_STORE&&(t=$SM.MAX_STORE);try{eval("("+r+") = value")}catch(u){$SM.createState(n,t)}n.indexOf("inventory")===0&&$SM.get(n,!0)<0&&(eval("("+r+") = 0"),Engine.log("WARNING: state:"+n+" can not be a negative value. Set to 0 instead."));i||(Engine.saveGame(),$SM.fireUpdate(n))},setM:function(n,t,i){$SM.buildPath(n);$SM.get(n)===undefined&&$SM.set(n,{},!0);for(var r in t)$SM.set(n+'["'+r+'"]',t[r],!0);i||(Engine.saveGame(),$SM.fireUpdate(n))},add:function(n,t,i){var u=0,r=$SM.get(n,!0);return r!=r?(Engine.log("WARNING: "+n+" was corrupted (NaN). Resetting to 0."),r=0,$SM.set(n,r+t,i)):typeof r!="number"||typeof t!="number"?typeof r.qty=="number"?typeof t=="number"?$SM.set(n,r.qty+t,i):typeof t.qty=="number"?$SM.set(n,r.qty+t.qty,i):(Engine.log("WARNING: Can not do math with state:"+n+" or value:"+t+" because at least one is not a number."),u=1):(Engine.log("WARNING: Can not do math with state:"+n+" or value:"+t+" because at least one is not a number."),u=1):$SM.set(n,r+t,i),u},addM:function(n,t,i){var u=0,r;$SM.get(n)===undefined&&$SM.set(n,{},!0);for(r in t)$SM.add(n+'["'+r+'"]',t[r],!0)&&u++;return i||(Engine.saveGame(),$SM.fireUpdate(n)),u},get:function(n,t){var i=null,r=$SM.buildPath(n);try{eval("whichState = ("+r+")")}catch(u){i=undefined}return(!i||i=={})&&t?0:i},setget:function(n,t,i){return $SM.set(n,t,i),eval("("+$SM.buildPath(n)+")")},remove:function(n,t){var i=$SM.buildPath(n);try{eval("(delete "+i+")")}catch(r){Engine.log("WARNING: Tried to remove non-existant state '"+n+"'.")}t||(Engine.saveGame(),$SM.fireUpdate(n))},removeBranch:function(n,t){for(var i in $SM.get(n))typeof $SM.get(n)[i]=="object"&&$SM.removeBranch(n+'["'+i+'"]');$.isEmptyObject($SM.get(n))&&$SM.remove(n);t||(Engine.saveGame(),$SM.fireUpdate(n))},buildPath:function(n){var t=n.charAt(0)=="["?"":".";return"State"+t+n},fireUpdate:function(n,t){var i=$SM.getCategory(n);n==undefined&&(n=i="all");$.Dispatch("stateUpdate").publish({category:i,stateName:n});t&&Engine.saveGame()},getCategory:function(n){var t=n.indexOf("["),i=n.indexOf("."),r=null;return r=t==-1||i==-1?t>i?t:i:t<i?t:i,r==-1?n:n.substr(0,r)},updateOldState:function(){var n=$SM.get("version");typeof n!="number"&&(n=1)},addPerk:function(n){Story.activeStory!=undefined&&Story.activeStory!=null&&Story.activeStory.Perks[n]!=undefined&&($SM.set('player.perks["'+n+'"]',!0),Notifications.notify(null,Story.activeStory.Perks[n].notify))},hasPerk:function(n){return $SM.get('player.perks["'+n+'"]')},handleStateUpdates:function(){}},$SM=StateManager,Story={DEFAULT_STORY:"LostIsland",options:{inCommandEvent:!1,commandEventCallback:null,canMove:!0},activeStory:null,playerMoves:0,previousRoom:null,activeRoom:null,init:function(n){var t,i,r;this.options=$.extend(this.options,n);Story.StoryPool=[];Story.StoryPool.LostIsland=Story.LostIsland;t=$SM.get("story.activeStory");t==undefined&&(t=Story.setDefaultStory());Story.setStory(t);i=$SM.get("story.moves");i==undefined&&(i=0);Story.playerMoves=i;Story.activeStory.init();r=$("<div>").attr("id","gameRoomPanel").appendTo("#gameMain");Story.updateRoomPanel();Story.checkUISettings();$.Dispatch("stateUpdate").subscribe(Story.handleStateUpdates)},checkUISettings:function(){Engine.ui.roomPanel?$("#gameRoomPanel").css({display:"block"}):$("#gameRoomPanel").css({display:"none"})},updateRoomPanel:function(){var u,n,t,i,r;$("#gameRoomPanel").html("");u=Room.getRoom(Story.activeRoom);$("<div>").addClass("gamePanelHeader").text(Story.activeStory.STORY_NAME).appendTo("#gameRoomPanel");$("<div>").addClass("gamePanelHeader").css({"font-size":"14px","margin-bottom":"10px"}).text(u.name).appendTo("#gameRoomPanel");n=u.exits.north;n=n==undefined?"None":n.room.visited!=undefined&&n.room.visited?n.room.name:"Unknown";$("<div>").addClass("roomExitItem").html("<b>North<\/b> - "+n).appendTo("#gameRoomPanel");t=u.exits.east;t=t==undefined?"None":t.room.visited!=undefined&&t.room.visited?t.room.name:"Unknown";$("<div>").addClass("roomExitItem").html("<b>East<\/b> - "+t).appendTo("#gameRoomPanel");i=u.exits.south;i=i==undefined?"None":i.room.visited!=undefined&&i.room.visited?i.room.name:"Unknown";$("<div>").addClass("roomExitItem").html("<b>South<\/b> - "+i).appendTo("#gameRoomPanel");r=u.exits.west;r=r==undefined?"None":r.room.visited!=undefined&&r.room.visited?r.room.name:"Unknown";$("<div>").addClass("roomExitItem").html("<b>West<\/b> - "+r).appendTo("#gameRoomPanel")},go:function(n){var t=Room.getRoom(Story.activeRoom),r,u,i,f;if(n=="back"){if(Story.previousRoom==null){Notifications.notify("There is nowhere to go back too.");return}r=Room.getRoom(Story.previousRoom);r.canEnterFunc();r.canEnter?(i=t,i.triggerExit(),Notifications.clear(Commands.LAST_COMMAND),Story.setRoom(r),Story.previousRoom=i):Notifications.notify(r.lockedDesc)}if(t.exits[n]===undefined)Notifications.notify("There is no exit '"+n+"'.");else if(u=t.exits[n].room,u.canEnterFunc(),u.canEnter){if(i=t,t.exits[n].onChange!=undefined&&typeof t.exits[n].onChange=="function"&&(f=t.exits[n].onChange(),!f))return;i.triggerExit();Notifications.clear(Commands.LAST_COMMAND);Story.setRoom(u);Story.previousRoom=i}else Notifications.notify(u.lockedDesc)},look:function(){Room.getRoom(Story.activeRoom).triggerLook()},setRoom:function(n){n!==undefined&&(typeof n!="object"&&(n=Room.getRoom(n)),Story.activeRoom=n.id,$SM.set("story.room",Story.activeRoom),$SM.set("story.moves",Story.playerMoves++),n.triggerEnter(),Story.updateRoomPanel())},setStory:function(n){n!==undefined&&(Story.activeStory=Story.StoryPool[n])},setDefaultStory:function(){return $SM.set("story.activeStory",Story.DEFAULT_STORY),Story.DEFAULT_STORY},addStoryEvent:function(n){Events.Story.push(n);Events.updateEventPool()},addEncounterEvent:function(n){Events.Encounters.push(n)},handleStateUpdates:function(){}};Events.Encounters=[{title:"Combat - Archie",isAvailable:function(){return!0},scenes:{start:{combat:!0,enemy:"archie",enemyName:"Archie",deathMessage:"Archie is dead",damage:1,hit:.3,attackDelay:3,health:3,loot:{meat:{min:1,max:3,chance:1}},notification:"A wild Archie runs at you with arms help high"}}},{title:"Combat - Archie with a Gun",isAvailable:function(){return!0},scenes:{start:{combat:!0,enemy:"archie",enemyName:"Archie",deathMessage:"Archie is dead",damage:3,hit:.2,attackDelay:4,health:3,ranged:!0,loot:{meat:{min:1,max:3,chance:1}},notification:"A wild Archie waving a gun around"}}}];Events.Global=[];Events.Story=[];Story.LostIsland={STORY_NAME:"The Lost Island",DEFAULT_ROOM:null,Perks:{boxer:{name:"boxer",desc:"punches do more damage",notify:"learned to throw punches with purpose"},"martial artist":{name:"martial artist",desc:"do max damage in hand to hand combat",notify:"learned to fight effectively without weapons"},evasive:{name:"evasive",desc:"dodge attacks more effectively",notify:"learned to be where they're not"},hawkeye:{name:"hawkeye",desc:"you notice even the littlest of things",notify:"learned to look more closely"},stealthy:{name:"stealthy",desc:"better avoid conflict",notify:"learned how to not be seen"}},init:function(){Story.LostIsland.createRooms();Story.LostIsland.createItems();Story.LostIsland.createEvents();Story.LostIsland.createExits();Story.LostIsland.setDefaultRoom();Story.LostIsland.loadStory()},loadStory:function(){var n=$SM.get("story.room");n==undefined&&(n=Story.LostIsland.DEFAULT_ROOM);Story.setRoom(n)},setDefaultRoom:function(){Story.LostIsland.DEFAULT_ROOM=Room.getRoom("beach")},createRooms:function(){Room.createRoom("beach",{name:"Beach",description:"You wake up Lying face first on a sandy beach, while you spit out all the sand in your mouth you look around.[[break]]To your <b>south<\/b> all you can see is ocean as far as the eye can see, however to the <b>north<\/b> you can see a huge forest.",loot:{compass:1},commands:[[["look south","look at ocean"],function(){Notifications.notify("You look at the ocean, it seems to go as far as you can see.")}],[["eat sand"],function(){Notifications.notify("Why?")}],[["take compass","pickup compass","pick up compass"],function(){Player.pickupItem("compass",1,"beach",!0);$SM.set("game.compass",!0);Notifications.notify("You pickup the compass from the floor, this should help you find your way around.")}]],Events:[{title:"Combat - Large Crab",isAvailable:function(){return Story.playerMoves>1},scenes:{start:{combat:!0,enemy:"large crab",enemyName:"Large Crab",deathMessage:"You killed the large crab",damage:2,hit:.5,attackDelay:3,health:5,loot:{meat:{min:2,max:6,chance:1}},notification:"A Crab the size of a person scurries across the beach towards you."}}}],onEnter:function(){Math.random()<=.2&&Events.triggerRoomEvent(Room.getRoom("beach").Events)}});Room.createRoom("forest-1",{name:"Forest",description:"You enter a huge forest with trees so high you can hardly see the sky, It casts a large shadow making it almost dark inside the forest.[[break]]You see paths in every direction, to the <b>south<\/b> you see the beach, <b>west<\/b> you hear the sound of running water, both <b>east<\/b> and <b>north<\/b> you can only see forest.",commands:[],Events:[{title:"Mysterious Smoke",isAvailable:function(){return!$SM.get("timers.smokeEvent",!0)},scenes:{start:{text:["A black mysterious smoke surrounds you and you start to feel tired."],notification:"A black mysterious smoke surrounds you and you start to feel tired.",buttons:{leave:{text:"wake up",cooldown:4,onChoose:function(){Notifications.clear(Commands.LAST_COMMAND);Notifications.notify("As you wake up things seem different, like your in a different part of the forest.");var n=Math.floor(Math.random()*3+2);Story.setRoom("forest-"+n)},nextScene:"end"}}}}},{title:"Wild Beast",isAvailable:function(){return!0},scenes:{start:{text:["As you look around the forest you see a large animal in the distance"],notification:"You see a large animal in the distance",buttons:{investigate:{text:"Investigate",nextScene:{.6:"fight",.9:"friendly",1:"runs"}},ignore:{text:"Ignore",nextScene:{.3:"fight",1:"end"}}}},fight:{combat:!0,enemy:"large bear",enemyName:"Large Bear",damage:2,hit:.5,attackDelay:4,health:8,notification:"A large bear runs at you",deathMessage:"You killed the bear",loot:{meat:{min:2,max:6,chance:1}},buttons:{leave:{text:"leave",cooldown:Events._LEAVE_COOLDOWN,nextScene:"end"}}},friendly:{text:["As you get closer the the animal you notice it's attualy a large chicken","It doesn't seem aggressive so you reach out to touch and before you can it scurries away","As it does you notice some large eggs on the floor"],loot:{egg:{min:1,max:5,change:1}},buttons:{leave:{text:"Take and Leave",cooldown:Events._LEAVE_COOLDOWN,nextScene:"end"}}},runs:{text:["As you approch the animal it spots you and runs away out of sight"],buttons:{leave:{text:"leave",nextScene:"end"}}}}}],onEnter:function(){if(!Player.inventory.compass&&Math.random()<=.5){Notifications.clear(Commands.LAST_COMMAND);Notifications.notify("You wonder around the forest not really knowing where to go, you start to lose your way and get lost.");var n=Math.floor(Math.random()*3+2);Story.setRoom("forest-"+n)}Math.random()<=.4&&Events.triggerRoomEvent(Room.getRoom("forest-1").Events)}});Room.createRoom("forest-2",{name:"Forest",description:"Forest 2"});Room.createRoom("forest-3",{name:"Forest",description:"Forest 3"});Room.createRoom("forest-4",{name:"Forest",description:"Forest 4"});Room.updateRoomsState()},createItems:function(){Items.addItem("food","egg",{name:"egg",type:"food",desc:"A larger than normal egg",heal:2})},createEvents:function(){},createExits:function(){Room.addExit(Room.getRoom("beach"),"north",{room:Room.getRoom("forest-1")});Room.addExit(Room.getRoom("forest-1"),"south",{room:Room.getRoom("beach")});Room.addExit(Room.getRoom("forest-1"),"north",{room:Room.getRoom("forest-2")});Room.addExit(Room.getRoom("forest-2"),"south",{room:Room.getRoom("forest-1")});Room.addExit(Room.getRoom("forest-2"),"east",{room:Room.getRoom("forest-3")});Room.addExit(Room.getRoom("forest-3"),"west",{room:Room.getRoom("forest-2")});Room.addExit(Room.getRoom("forest-3"),"north",{room:Room.getRoom("forest-4")});Room.addExit(Room.getRoom("forest-4"),"south",{room:Room.getRoom("forest-3")})}};