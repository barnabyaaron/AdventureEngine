function scrollByX(n,t){var i=parseInt(n.css("top"),10);n.css("top",i+t+"px")}(function(){function t(n){return $(n.target).hasClass("menuBtn")}function i(){return!0}var n=window.Engine={VERSION:1,GAME_OVER:!1,MAX_STORE:99999999999999,SAVE_DISPLAY:3e4,options:{state:null,debug:!1,log:!1},topics:{},activeRoom:null,Perks:{boxer:{name:"boxer",desc:"punches do more damage",notify:"learned to throw punches with purpose"},"martial artist":{name:"martial artist",desc:"do max damage in hand to hand combat",notify:"learned to fight effectively without weapons"},"slow metabolism":{name:"slow metabolism",desc:"go twice as far without eating",notify:"learned how to ignore the hunger"},evasive:{name:"evasive",desc:"dodge attacks more effectively",notify:"learned to be where they're not"},hawkeye:{name:"hawkeye",desc:"you notice even the littlest of things",notify:"learned to look more closely"},stealthy:{name:"stealthy",desc:"better avoid conflict",notify:"learned how to not be seen"},gastronome:{name:"gatrononome",desc:"restores more health when eating",notify:"learned to make the most of food"}},init:function(t){this.options=$.extend(this.options,t);this._debug=this.options.debug;this._log=this.options.log;!n.browserValid();n.isMobile();this.options.state!=null?window.State=this.options.state:n.loadGame();var i=$("<div>").addClass("gameMenu").appendTo("#gameFooter");$("<span>").addClass("menuBtn").text("restart.").click(n.confirmDelete).appendTo(i);$("<span>").addClass("menuBtn").text("save.").click(n.exportImport).appendTo(i);$("#commandTxt").on("keypress",n.keyPress);$.Dispatch("stateUpdate").subscribe(n.handleStateUpdates);$SM.init();Notifications.init()},browserValid:function(){return location.search.indexOf("ignorebrowser=true")>=0||typeof Storage!="undefined"&&!oldIE},isMobile:function(){return location.search.indexOf("ignorebrowser=true")<0&&/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)},saveGame:function(){typeof Storage!="undefined"&&localStorage&&(n._saveTimer!=null&&clearTimeout(n._saveTimer),(typeof n._lastNotify=="undefined"||Date.now()-n._lastNotify>n.SAVE_DISPLAY)&&($("#saveNotify").css("opacity",1).animate({opacity:0},1e3,"linear"),n._lastNotify=Date.now()),localStorage.gameState=JSON.stringify(State))},loadGame:function(){try{var t=JSON.parse(localStorage.gameState);t&&(State=t,$SM.updateOldState(),n.log("loaded save!"))}catch(i){State={};$SM.set("version",n.VERSION);n.event("progress","new game")}},exportImport:function(){},generateExport64:function(){var n=Base64.encode(localStorage.gameState);return n=n.replace(/\s/g,""),n=n.replace(/\./g,""),n.replace(/\n/g,"")},export64:function(){return n.saveGame(),n.enableSelection(),n.generateExport64()},import64:function(t){n.event("progress","import");n.disableSelection();t=t.replace(/\s/g,"");t=t.replace(/\./g,"");t=t.replace(/\n/g,"");var i=Base64.decode(t);localStorage.gameState=i;location.reload()},event:function(n,t){typeof ga=="function"&&ga("send","event",n,t)},confirmDelete:function(){},deleteSave:function(n){if(typeof Storage!="undefined"&&localStorage){var t=Prestige.get();window.State={};localStorage.clear();Prestige.set(t)}n||location.reload()},getGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=Math.random()*16|0,i=n=="x"?t:t&3|8;return i.toString(16)})},log:function(n){this._log&&console.log(n)},keyLock:!1,keyPress:function(t){t.which===13&&(t.preventDefault(),n.keyLock||Notifications.notify("> "+$("#commandTxt").val()),$("#commandTxt").val(""))},disableSelection:function(){document.onselectstart=t;document.onmousedown=t},enableSelection:function(){document.onselectstart=i;document.onmousedown=i},autoSelect:function(n){$(n).focus().select()},handleStateUpdates:function(){},setInterval:function(t,i,r){return n.options.doubleTime&&!r&&(n.log("Double time, cutting interval in half"),i/=2),setInterval(t,i)},setTimeout:function(t,i,r){return n.options.doubleTime&&!r&&(n.log("Double time, cutting timeout in half"),i/=2),setTimeout(t,i)}}})();$.Dispatch=function(n){var t,i=n&&Engine.topics[n];return i||(t=jQuery.Callbacks(),i={publish:t.fire,subscribe:t.add,unsubscribe:t.remove},n&&(Engine.topics[n]=i)),i};$(document).ready(function(){$("#startGameBtn").click(function(){Engine.init();$("#devGameModal").modal("show")})});var Events={_EVENT_TIME_RANGE:[3,6],init:function(n){this.options=$.extend(this.options,n);Events.EventPool=[].concat(Events.Global,Events.Room);Events.eventStack=[];Events.scheduleNextEvent();$.Dispatch("stateUpdate").subscribe(Events.handleStateUpdates);Events.initDelay()},options:{},delayState:"wait",triggerEvent:function(){var n,i,t,r;if(Events.activeEvent()==null){n=[];for(i in Events.EventPool)t=Events.EventPool[i],t.isAvailable()&&n.push(t);if(n.length===0){Events.scheduleNextEvent(.5);return}r=Math.floor(Math.random()*n.length);Events.startEvent(n[r])}Events.scheduleNextEvent()},triggerFight:function(){var n=[],i,t,r;for(i in Events.Encounters)t=Events.Encounters[i],t.isAvailable()&&n.push(t);r=Math.floor(Math.random()*n.length);Events.startEvent(n[r])},activeEvent:function(){return Events.eventStack&&Events.eventStack.length>0?Events.eventStack[0]:null},eventPanel:function(){return Events.activeEvent().eventPanel},startEvent:function(n,t){if(n){Engine.event("game event","event");Engine.keyLock=!0;Engine.tabNavigation=!1;Button.saveCooldown=!1;Events.eventStack.unshift(n);n.eventPanel=$("<div>").attr("id","event").addClass("eventPanel").css("opacity","0");t!=null&&t.width!=null&&Events.eventPanel().css("width",t.width);$("<div>").addClass("eventTitle").text(Events.activeEvent().title).appendTo(Events.eventPanel());$("<div>").attr("id","description").appendTo(Events.eventPanel());$("<div>").attr("id","buttons").appendTo(Events.eventPanel());Events.loadScene("start");$("div#gameWrapper").append(Events.eventPanel());Events.eventPanel().animate({opacity:1},Events._PANEL_FADE,"linear");var i=Events.activeEvent().scenes[Events.activeScene];i.blink&&Events.blinkTitle()}},scheduleNextEvent:function(n){var t=Math.floor(Math.random()*(Events._EVENT_TIME_RANGE[1]-Events._EVENT_TIME_RANGE[0]))+Events._EVENT_TIME_RANGE[0];n>0&&(t*=n);Engine.log("next event scheduled in "+t+" minutes");Events._eventTimeout=Engine.setTimeout(Events.triggerEvent,t*6e4)},endEvent:function(){Events.eventPanel().animate({opacity:0},Events._PANEL_FADE,"linear",function(){Events.eventPanel().remove();Events.activeEvent().eventPanel=null;Events.eventStack.shift();Engine.log(Events.eventStack.length+" events remaining");Engine.keyLock=!1;Engine.tabNavigation=!0;Button.saveCooldown=!0;Events.BLINK_INTERVAL&&Events.stopTitleBlink();$("body").focus()})},handleStateUpdates:function(n){n.category=="stores"&&Events.activeEvent()!=null&&Events.updateButtons()},initDelay:function(){$SM.get(Events.delayState)&&Events.recallDelay(Events.delayState,Events)},recallDelay:function(n,t){var r=$SM.get(n);for(var i in r)typeof r[i]=="object"?Events.recallDelay(n+'["'+i+'"]',t[i]):typeof t[i]=="function"?t[i]():$SM.remove(n);$.isEmptyObject(r)&&$SM.remove(n)},saveDelay:function(n,t,i){var r=Events.delayState+"."+t,i,u;i?$SM.set(r,i):i=$SM.get(r,!0);u=Engine.setInterval(function(){$SM.set(r,$SM.get(r)-.5,!0)},500);Engine.setTimeout(function(){window.clearInterval(u);$SM.remove(r);$SM.removeBranch(Events.delayState);n()},i*1e3)}},Notifications={init:function(n){this.options=$.extend(this.options,n);elem=$("<div>").attr({id:"gameNotifications",className:"notifications"});$("<div>").attr("id","notifyGradient").appendTo(elem);elem.appendTo("#gameMain")},options:{},elem:null,notifyQueue:{},notify:function(n,t,i){typeof n!="undefined"&&(n.slice(-1)!="."&&(n+="."),t!=null&&Engine.activeRoom!=t?i||(typeof this.notifyQueue[t]=="undefined"&&(this.notifyQueue[t]=[]),this.notifyQueue[t].push(n)):Notifications.printMessage(n),Engine.saveGame())},clearHidden:function(){var n=$("#notifyGradient").position().top+$("#notifyGradient").outerHeight(!0);$(".notification").each(function(){$(this).position().top>n&&$(this).remove()})},printMessage:function(n){var t=$("<div>").addClass("notification").css("opacity","0").html(n).prependTo("div#gameNotifications");t.animate({opacity:1},500,"linear",function(){Notifications.clearHidden()})},printQueue:function(n){if(typeof this.notifyQueue[n]!="undefined")while(this.notifyQueue[n].length>0)Notifications.printMessage(this.notifyQueue[n].shift())}},StateManager={MAX_STORE:99999999999999,options:{},init:function(n){var t,i;this.options=$.extend(this.options,n);t=["features","stores","inventory","player","timers","game","playStats","previous","calldown","story"];for(i in t)$SM.get(t[i])||$SM.set(t[i],{});$.Dispatch("stateUpdate").subscribe($SM.handleStateUpdates)},createState:function(n,t){for(var r,f,e,u=n.split(/[.\[\]'"]+/),i=0;i<u.length;i++)u[i]===""&&(u.splice(i,1),i--);for(r=State,f=null,i=0,e=u.length-1;i<e;i++)f=u[i],r[f]===undefined&&(r[f]={}),r=r[f];return r[u[i]]=t,r},set:function(n,t,i){var r=$SM.buildPath(n);typeof t=="number"&&t>$SM.MAX_STORE&&(t=$SM.MAX_STORE);try{eval("("+r+") = value")}catch(u){$SM.createState(n,t)}n.indexOf("stores")===0&&$SM.get(n,!0)<0&&(eval("("+r+") = 0"),Engine.log("WARNING: state:"+n+" can not be a negative value. Set to 0 instead."));i||(Engine.saveGame(),$SM.fireUpdate(n))},setM:function(n,t,i){$SM.buildPath(n);$SM.get(n)===undefined&&$SM.set(n,{},!0);for(var r in t)$SM.set(n+'["'+r+'"]',t[r],!0);i||(Engine.saveGame(),$SM.fireUpdate(n))},add:function(n,t,i){var u=0,r=$SM.get(n,!0);return r!=r?(Engine.log("WARNING: "+n+" was corrupted (NaN). Resetting to 0."),r=0,$SM.set(n,r+t,i)):typeof r!="number"||typeof t!="number"?(Engine.log("WARNING: Can not do math with state:"+n+" or value:"+t+" because at least one is not a number."),u=1):$SM.set(n,r+t,i),u},addM:function(n,t,i){var u=0,r;$SM.get(n)===undefined&&$SM.set(n,{},!0);for(r in t)$SM.add(n+'["'+r+'"]',t[r],!0)&&u++;return i||(Engine.saveGame(),$SM.fireUpdate(n)),u},get:function(n,t){var i=null,r=$SM.buildPath(n);try{eval("whichState = ("+r+")")}catch(u){i=undefined}return(!i||i=={})&&t?0:i},setget:function(n,t,i){return $SM.set(n,t,i),eval("("+$SM.buildPath(n)+")")},remove:function(n,t){var i=$SM.buildPath(n);try{eval("(delete "+i+")")}catch(r){Engine.log("WARNING: Tried to remove non-existant state '"+n+"'.")}t||(Engine.saveGame(),$SM.fireUpdate(n))},removeBranch:function(n,t){for(var i in $SM.get(n))typeof $SM.get(n)[i]=="object"&&$SM.removeBranch(n+'["'+i+'"]');$.isEmptyObject($SM.get(n))&&$SM.remove(n);t||(Engine.saveGame(),$SM.fireUpdate(n))},buildPath:function(n){var t=n.charAt(0)=="["?"":".";return"State"+t+n},fireUpdate:function(n,t){var i=$SM.getCategory(n);n==undefined&&(n=i="all");$.Dispatch("stateUpdate").publish({category:i,stateName:n});t&&Engine.saveGame()},getCategory:function(n){var t=n.indexOf("["),i=n.indexOf("."),r=null;return r=t==-1||i==-1?t>i?t:i:t<i?t:i,r==-1?n:n.substr(0,r)},updateOldState:function(){var n=$SM.get("version");typeof n!="number"&&(n=1)},addPerk:function(n){$SM.set('player.perks["'+n+'"]',!0);Notifications.notify(null,Engine.Perks[n].notify)},hasPerk:function(n){return $SM.get('player.perks["'+n+'"]')},handleStateUpdates:function(){}},$SM=StateManager;