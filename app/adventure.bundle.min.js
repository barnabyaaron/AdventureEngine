function scrollByX(n,t){var i=parseInt(n.css("top"),10);n.css("top",i+t+"px")}var Button={Button:function(n){var t,u,i,r;if(typeof n.cooldown=="number"&&(this.data_cooldown=n.cooldown),this.data_remaining=0,typeof n.click=="function"&&(this.data_handler=n.click),t=$("<div>").attr("id",typeof n.id!="undefined"?n.id:"BTN_"+Engine.getGuid()).addClass("button").text(typeof n.text!="undefind"?n.text:"button").click(function(){$(this).hasClass("disabled")||(Button.cooldown($(this)),$(this).data("handler")($(this)))}).data("handler",typeof n.click=="function"?n.click:function(){Engine.log("click")}).data("remaining",0).data("cooldown",typeof n.cooldown=="number"?n.cooldown:0),t.append($("<div>").addClass("cooldown")),Button.cooldown(t,"state"),n.cost){u=n.ttPos?n.ttPos:"buttom right";i=$("<div>").addClass("tooltip"+u);for(r in n.cost)$("<div>").addClass("row_key").text(r).appendTo(i),$("<div>").addClass("row_val").text(n.cost[r]).appendTo(i);i.children().length>0&&i.appendTo(t)}return n.width&&t.css("width",n.width),t},saveCooldown:!0,setDisabled:function(n,t){n&&(t||n.data("onCooldown")?t&&n.addClass("disabled"):n.removeClass("disabled"),n.data("disabled",t))},isDisabled:function(n){return n?n.data("disabled")===!0:!1},cooldown:function(n,t){var u=n.data("cooldown"),i="cooldown."+n.attr("id"),r,f,e;if(u>0){switch(t){case"state":if(!$SM.get(i))return;r=Math.min($SM.get(i),u);f=(r/u).toFixed(4);break;default:r=u;f=1}Button.clearCooldown(n);Button.saveCooldown&&($SM.set(i,r),n.data("countdown",Engine.setInterval(function(){$SM.set(i,$SM.get(i,!0)-.5,!0)},500)));e=r;Engine.options.doubleTime&&(e/=2);$("div.cooldown",n).width(f*100+"%").animate({width:"0%"},e*1e3,"linear",function(){Button.clearCooldown(n,!0)});n.addClass("disabled");n.data("onCooldown",!0)}},clearCooldown:function(n,t){var t=t||!1;t||$("div.cooldown",n).stop(!0,!0);n.data("onCooldown",!1);n.data("countdown")&&(window.clearInterval(n.data("countdown")),$SM.remove("cooldown."+n.attr("id")),n.removeData("countdown"));n.data("disabled")||n.removeClass("disabled")}},Commands={options:{},init:function(n){this.options=$.extend(this.options,n);$.Dispatch("stateUpdate").subscribe(Events.handleStateUpdates)},trigger:function(n){switch(n){case"fight":Events.triggerFight();break;case"heal":Player.setHp(Player.getMaxHealth())}},handleStateUpdates:function(){}};(function(){function t(n){return $(n.target).hasClass("menuBtn")}function i(){return!0}var n=window.Engine={GAME_STARTED:!1,VERSION:1,GAME_OVER:!1,MAX_STORE:99999999999999,SAVE_DISPLAY:3e4,options:{state:null,debug:!1,log:!1},topics:{},activeRoom:null,Perks:{boxer:{name:"boxer",desc:"punches do more damage",notify:"learned to throw punches with purpose"},"martial artist":{name:"martial artist",desc:"do max damage in hand to hand combat",notify:"learned to fight effectively without weapons"},evasive:{name:"evasive",desc:"dodge attacks more effectively",notify:"learned to be where they're not"},hawkeye:{name:"hawkeye",desc:"you notice even the littlest of things",notify:"learned to look more closely"},stealthy:{name:"stealthy",desc:"better avoid conflict",notify:"learned how to not be seen"}},init:function(t){if(n.GAME_STARTED=$SM.get("game.started",!0),!n.GAME_STARTED){this.options=$.extend(this.options,t);this._debug=this.options.debug;this._log=this.options.log;!n.browserValid();n.isMobile();this.options.state!=null?window.State=this.options.state:n.loadGame();var i=$("<div>").addClass("gameMenu").appendTo("#gameFooter");$("<span>").addClass("menuBtn").text("restart.").click(n.confirmDelete).appendTo(i);$("<span>").addClass("menuBtn").text("save.").click(n.exportImport).appendTo(i);$("#commandTxt").on("keypress",n.keyPress);$.Dispatch("stateUpdate").subscribe(n.handleStateUpdates);$SM.init();Notifications.init();Items.init();Events.init();Story.init();Player.init();n.GAME_STARTED=!0;$SM.set("game.started",n.GAME_STARTED)}},browserValid:function(){return location.search.indexOf("ignorebrowser=true")>=0||typeof Storage!="undefined"&&!oldIE},isMobile:function(){return location.search.indexOf("ignorebrowser=true")<0&&/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)},saveGame:function(){typeof Storage!="undefined"&&localStorage&&(n._saveTimer!=null&&clearTimeout(n._saveTimer),(typeof n._lastNotify=="undefined"||Date.now()-n._lastNotify>n.SAVE_DISPLAY)&&($("#saveNotify").css("opacity",1).animate({opacity:0},1e3,"linear"),n._lastNotify=Date.now()),localStorage.gameState=JSON.stringify(State))},loadGame:function(){try{var t=JSON.parse(localStorage.gameState);t&&(State=t,$SM.updateOldState(),n.log("loaded save!"))}catch(i){State={};$SM.set("version",n.VERSION);n.event("progress","new game")}},exportImport:function(){Events.startEvent({title:"Export / Import",scenes:{start:{text:["export or import save data, for backing up","or migrating computers"],buttons:{"export":{text:"export",nextScene:{1:"inputExport"}},"import":{text:"import",nextScene:{1:"confirm"}},cancel:{text:"cancel",nextScene:"end"}}},inputExport:{text:["save this."],textarea:n.export64(),onLoad:function(){n.event("progress","export")},readonly:!0,buttons:{done:{text:"got it",nextScene:"end",onChoose:n.disableSelection}}},confirm:{text:["are you sure?","if the code is invalid, all data will be lost.","this is irreversible."],buttons:{yes:{text:"yes",nextScene:{1:"inputImport"},onChoose:n.enableSelection},no:{text:"no",nextScene:{1:"start"}}}},inputImport:{text:["put the save code here."],textarea:"",buttons:{okay:{text:"import",nextScene:"end",onChoose:n.import64},cancel:{text:"cancel",nextScene:"end"}}}}})},generateExport64:function(){var n=Base64.encode(localStorage.gameState);return n=n.replace(/\s/g,""),n=n.replace(/\./g,""),n.replace(/\n/g,"")},export64:function(){return n.saveGame(),n.enableSelection(),n.generateExport64()},import64:function(t){n.event("progress","import");n.disableSelection();t=t.replace(/\s/g,"");t=t.replace(/\./g,"");t=t.replace(/\n/g,"");var i=Base64.decode(t);localStorage.gameState=i;location.reload()},event:function(n,t){typeof ga=="function"&&ga("send","event",n,t)},confirmDelete:function(){Events.startEvent({title:"Restart?",scenes:{start:{text:["restart the game?"],buttons:{yes:{text:"yes",nextScene:"end",onChoose:n.deleteSave},no:{text:"no",nextScene:"end"}}}}})},deleteSave:function(t){n.GAME_OVER=!1;typeof Storage!="undefined"&&localStorage&&(window.State={},localStorage.clear());t||location.reload()},endGame:function(){n.deleteSave(!0)},getGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=Math.random()*16|0,i=n=="x"?t:t&3|8;return i.toString(16)})},log:function(n){this._log&&console.log(n)},keyLock:!1,keyPress:function(t){t.which===13&&(t.preventDefault(),n.keyLock||n.GAME_OVER||(Notifications.notify("> "+$("#commandTxt").val()),Commands.trigger($("#commandTxt").val())),$("#commandTxt").val(""))},disableSelection:function(){document.onselectstart=t;document.onmousedown=t},enableSelection:function(){document.onselectstart=i;document.onmousedown=i},autoSelect:function(n){$(n).focus().select()},handleStateUpdates:function(){},setInterval:function(t,i,r){return n.options.doubleTime&&!r&&(n.log("Double time, cutting interval in half"),i/=2),setInterval(t,i)},setTimeout:function(t,i,r){return n.options.doubleTime&&!r&&(n.log("Double time, cutting timeout in half"),i/=2),setTimeout(t,i)}}})();$.Dispatch=function(n){var t,i=n&&Engine.topics[n];return i||(t=jQuery.Callbacks(),i={publish:t.fire,subscribe:t.add,unsubscribe:t.remove},n&&(Engine.topics[n]=i)),i};$(document).ready(function(){$("#startGameBtn").click(function(){Engine.init();$("#devGameModal").modal("show")})});var Events={_EVENT_TIME_RANGE:[3,6],_PANEL_FADE:200,_FLIGHT_SPEED:100,_MEDS_COOLDOWN:7,_LEAVE_COOLDOWN:1,STUN_DURATION:4e3,init:function(n){this.options=$.extend(this.options,n);Events.EventPool=[].concat(Events.Global,Events.Story);Events.eventStack=[];Events.scheduleNextEvent();$.Dispatch("stateUpdate").subscribe(Events.handleStateUpdates);Events.initDelay()},options:{},delayState:"wait",activeScene:null,activeEvent:function(){return Events.eventStack&&Events.eventStack.length>0?Events.eventStack[0]:null},eventPanel:function(){return Events.activeEvent().eventPanel},loadScene:function(n){Engine.log("loading scene: "+n);Events.activeScene=n;var t=Events.activeEvent().scenes[n];t.onLoad&&t.onLoad();t.notification&&Notifications.notify(null,t.notification);t.reward&&$SM.addM("stores",t.reward);$("#eventDescription",Events.eventPanel()).empty();$("#eventButtons",Events.eventPanel()).empty();t.combat?Events.startCombat(t):Events.startStory(t)},startStory:function(n){var t=$("#eventDescription",Events.eventPanel()),i=!1,r,u,f;for(r in n.text)$("<div>").text(n.text[r]).appendTo(t);n.textarea!=null&&(u=$("<textarea>").val(n.textarea).appendTo(t),n.readonly&&u.attr("readonly",!0),Engine.autoSelect("#eventDescription textarea"));n.loot&&(f=Events.drawLoot(n.loot));i=Events.drawButtons(n);Events.allowLeave(f,i)},startCombat:function(n){var e,u,i,r,t,f,o;Engine.event("game event","combat");Events.won=!1;e=$("#eventDescription",Events.eventPanel());$("<div>").text(n.notification).appendTo(e);Events.createCombatPanel(e,n);u=$("#eventButtons",Events.eventPanel());i=0;for(r in Items.Weapons)if(t=Items.Weapons[r],typeof Player.inventory[r]=="number"&&Player.inventory[r]>0){if(typeof t.damage!="number"||t.damage===0)i--;else if(t.cost)for(f in t.cost)o=t.cost[f],(typeof Player.inventory[f]!="number"||Player.inventory[f]<o)&&i--;i++;Events.createAttackButton(r).appendTo(u)}i===0&&Events.createAttackButton("fists").prependTo(u);(Player.inventory.medicine||0)!==0&&Events.createUseMedsButton().appendTo(u);Events._enemyAttackTimer=Engine.setTimeout(Events.enemyAttack,n.attackDelay*1e3)},createUseMedsButton:function(n){n==null&&(n=Events._MEDS_COOLDOWN);var t=new Button.Button({id:"meds",text:"use meds",cooldown:n,click:Events.useMeds,cost:{medicine:1}});return(Player.inventory.medicine||0)===0&&Button.setDisabled(t,!0),t},createAttackButton:function(n){var t=Items.Weapons[n],u=t.cooldown,i,r;t.type=="unarmed"&&$SM.hasPerk("martial artist")&&(u/=2);i=new Button.Button({id:"attack_"+n.replace(" ","-"),text:t.verb,cooldown:u,click:Events.useWeapon,cost:t.cost});typeof t.damage=="number"&&t.damage>0&&i.addClass("weaponButton");for(r in t.cost)if(typeof Player.inventory[r]!="number"||Player.inventory[r]<t.cost[r]){Button.setDisabled(i,!0);break}return i},drawFloatText:function(n,t){$("<div>").text(n).addClass("damageText").appendTo(t).animate({bottom:"100px",opacity:"0"},300,"linear",function(){$(this).remove()})},useMeds:function(){var n,t,i;Player.inventory.medicine>0&&(Player.inventory.medicine--,Player.updateSupplies(),Player.inventory.medicine===0&&Button.setDisabled($("#meds"),!0),n=Player.health,n+=Player.medsHeal(),n=n>Player.getMaxHealth()?Player.getMaxHealth():n,Player.setHp(n),Events.activeEvent()&&(t=$("#gamePlayerStats"),t.data("hp",n),Events.updateFighterDiv(t),Events.drawFloatText("+"+Player.medsHeal(),"#gamePlayer"),i=Events.setTakeAll(),Events.canLeave(i)))},useWeapon:function(n){var s,t,u,f,i,e,o,r,h;if(Events.activeEvent()){if(s=n.attr("id").substring(7).replace("-"," "),t=Items.Weapons[s],t.type=="unarmed"&&($SM.get("character.punches")||$SM.set("character.punches",0),$SM.add("character.punches",1),$SM.get("character.punches")!=50||$SM.hasPerk("boxer")?$SM.get("character.punches")!=150||$SM.hasPerk("martial artist")||$SM.addPerk("martial artist"):$SM.addPerk("boxer")),t.cost){u={};f=!1;for(i in t.cost){if(typeof Player.inventory[i]!="number"||Player.inventory[i]<t.cost[i])return;u[i]=-t.cost[i];Player.inventory[i]-t.cost[i]<t.cost[i]&&(f=!0)}for(i in u)Player.inventory[i]+=u[i];f&&(Button.setDisabled(n,!0),e=!1,$(".weaponButton").each(function(){if(!Button.isDisabled($(this))&&$(this).attr("id")!="attack_fists")return e=!0,!1}),e||(o=$("#attack_fists"),o.length===0?Events.createAttackButton("fists").prependTo("#buttons",Events.eventPanel()):Button.setDisabled(o,!1)));Player.updateSupplies()}r=-1;Math.random()<=Player.getHitChance()&&(r=t.damage,typeof r=="number"&&(t.type=="unarmed"&&$SM.hasPerk("boxer")&&(r*=2),t.type=="unarmed"&&$SM.hasPerk("martial artist")&&(r*=3)));h=t.type=="ranged"?Events.animateRanged:Events.animateMelee;h($("#gamePlayer"),r,function(){$("#gameEnemyStats").data("hp")<=0&&!Events.won&&Events.winFight()})}},animateMelee:function(n,t,i){var r,u,f;n.attr("id")=="gamePlayer"?(r={left:"50%"},u={left:"25%"},enemyStats=$("#gameEnemyStats"),f=$("#gameEnemy")):(r={right:"50%"},u={right:"25%"},enemyStats=$("#gamePlayerStats"),f=$("#gamePlayer"));n.stop(!0,!0).animate(r,Events._FIGHT_SPEED,function(){var r=enemyStats.data("hp"),e="";typeof t=="number"?t<0?(e="miss",t=0):(e="-"+t,r=r-t<0?0:r-t,enemyStats.data("hp",r),n.attr("id")=="gameEnemy"&&Player.setHp(r),Events.updateFighterDiv(enemyStats)):t=="stun"&&(e="stunned",enemyStats.data("stunned",!0),Engine.setTimeout(function(){enemyStats.data("stunned",!1)},Events.STUN_DURATION));Events.drawFloatText(e,f);$(this).animate(u,Events._FIGHT_SPEED,i)})},animateRanged:function(n,t,i){var r,u,f;n.attr("id")=="gamePlayer"?(r={left:"25%"},u={left:"50%"},enemyStats=$("#gameEnemyStats"),f=$("#gameEnemy")):(r={right:"25%"},u={right:"50%"},enemyStats=$("#gamePlayerStats"),f=$("#gamePlayer"));$("<div>").css(r).addClass("bullet").text("o").appendTo("#eventDescription").animate(u,Events._FIGHT_SPEED*2,"linear",function(){var r=enemyStats.data("hp"),u="";typeof t=="number"?t<0?(u="miss",t=0):(u="-"+t,r=r-t<0?0:r-t,enemyStats.data("hp",r),n.attr("id")=="gameEnemy"&&Player.setHp(r),Events.updateFighterDiv(enemyStats)):t=="stun"&&(u="stunned",enemyStats.data("stunned",!0),Engine.setTimeout(function(){enemyStats.data("stunned",!1)},Events.STUN_DURATION));Events.drawFloatText(u,f);$(this).remove();typeof i=="function"&&i()})},enemyAttack:function(){var n=Events.activeEvent().scenes[Events.activeScene],t,i,r;$("#gameEnemyStats").data("stunned")||(t=n.hit,t*=$SM.hasPerk("evasive")?.8:1,i=-1,Math.random()<=t&&(i=n.damage),r=n.ranged?Events.animateRanged:Events.animateMelee,r($("#gameEnemy"),i,function(){$("#gamePlayerStats").data("hp")<=0&&(clearTimeout(Events._enemyAttackTimer),Events.endEvent(),Player.die())}));Events._enemyAttackTimer=Engine.setTimeout(Events.enemyAttack,n.attackDelay*1e3)},winFight:function(){Events.won=!0;clearTimeout(Events._enemyAttackTimer);$("#gameEnemy").animate({opacity:0},300,"linear",function(){Engine.setTimeout(function(){var u;try{var n=Events.activeEvent().scenes[Events.activeScene],t=!1,r=$("#eventDescription",Events.eventPanel()),i=$("#eventButtons",Events.eventPanel());r.empty();i.empty();$("<div>").text(n.deathMessage).appendTo(r);u=Events.drawLoot(n.loot);n.buttons?t=Events.drawButtons(n):(t=new Button.Button({id:"leaveBtn",cooldown:Events._LEAVE_COOLDOWN,click:function(){n.nextScene&&n.nextScene!="end"?Events.loadScene(n.nextScene):Events.endEvent()},text:"leave"}),Button.cooldown(t.appendTo(i)),(Player.inventory.medicine||0)!==0&&Events.createUseMedsButton(0).appendTo(i));Events.allowLeave(u,t)}catch(f){}},1e3,!0)})},drawLoot:function(n){var h=$("#eventDescription",Events.eventPanel()),t=$("<div>").attr({id:"lootButtons","data-legend":"Loot:"}),f,i,e,o,r,u,s;for(f in n)i=n[f],Math.random()<i.chance&&(e=Math.floor(Math.random()*(i.max-i.min))+i.min,o=Events.drawLootRow(i.itemObj.name,e),o.appendTo(t));return t.appendTo(h),t.children().length>0?(r=$("<div>").addClass("takeETrow"),u=new Button.Button({id:"loot_takeEverything",text:"",cooldown:Events._LEAVE_COOLDOWN,click:Events.takeEverything}).appendTo(r),$("<span>").insertBefore(u.children(".cooldown")),$("<div>").addClass("clear").appendTo(r),r.appendTo(t),Events.setTakeAll(t)):(s=$("<div>").addClass("noLoot").text("nothing to take"),s.appendTo(t)),u||!1},drawDrop:function(n){var f=n.attr("id").substring(5).replace("-"," "),e=!1,o=Items.getWeight(f),s=Player.getFreeSpace(),i,t,u,r,h;if(o>s){Engine.log("drop menu");$("#dropMenu").length?(i=$("#dropMenu"),$("#dropMenu").empty()):(i=$("<div>").attr({id:"dropMenu","data-legend":"drop"}),e=!0);for(t in Player.inventory)f!=t&&(u=Items.getWeight(t),u>0&&(r=Math.ceil((o-s)/u),r>Player.inventory[t]&&(r=Player.inventory[t]),r>0&&(h=$("<div>").attr("id","drop_"+t.replace(" ","-")).text(_(t)+" x"+r).data("thing",t).data("num",r).click(Events.dropStuff).mouseenter(function(n){n.stopPropagation()}),h.appendTo(i))));$("<div>").attr("id","no_drop").text("nothing").mouseenter(function(n){n.stopPropagation()}).click(function(n){n.stopPropagation();i.remove()}).appendTo(i);e&&i.appendTo(n);n.one("mouseleave",function(){$("#dropMenu").remove()})}},drawLootRow:function(n,t){var r=n.replace(" ","-"),i=$("<div>").attr("id","loot_"+r).data("item",n).addClass("lootRow"),u=new Button.Button({id:"take_"+r,text:n+" ["+t+"]",click:Events.getLoot}).addClass("lootTake").data("numLeft",t).appendTo(i),f;return u.mouseenter(function(){Events.drawDrop(u)}),f=new Button.Button({id:"all_take_"+r,text:"take ",click:Events.takeAll}).addClass("lootTakeAll").appendTo(i),$("<span>").insertBefore(f.children(".cooldown")),$("<div>").addClass("clear").appendTo(i),i},setTakeAll:function(n){var n=n||$("#lootButtons"),i=!1,r=Player.getFreeSpace(),t=n.find("#loot_takeEverything");return n.children(".lootRow").each(function(){var f=$(this).data("item"),e=$(this).children(".lootTake").first(),n=$(this).children(".lootTakeAll").first(),u=e.data("numLeft"),t=Math.min(Math.floor(Player.getFreeSpace()/Items.getWeight(f)),u);n.data("numLeft",t);r-=u*Items.getWeight(f);t>0?(n.removeClass("disabled"),i=!0):n.addClass("disabled");t<u?n.children("span").first().text(t):n.children("span").first().text("all")}),i?t.removeClass("disabled"):t.addClass("disabled"),t.data("canTakeEverything",r>=0?!0:!1),t},allowLeave:function(n,t){n&&(t&&n.data("leaveBtn",t),Events.canLeave(n))},canLeave:function(n){var t="take everything",i=n.children("span"),u=n.data("leaveBtn")?n.data("canTakeEverything"):!1,r;u?(r=n.data("leaveBtn").text()||"leave",i.text(t+" and "+r),n.data("canLeave",!0),Button.cooldown(n)):(i.text(t),n.data("canLeave",!1))},dropStuff:function(n){var r,u,o;n.stopPropagation();var f=$(this),s=f.closest(".button"),t=f.data("thing"),h="take_"+t.replace(" ","-"),i=f.data("num"),e=$("#lootButtons");Engine.log("dropping "+i+" "+t);r=$("#"+h,e);r.length>0?(u=r.data("numLeft"),u+=i,r.text(_(t)+" ["+u+"]").data("numLeft",u)):(o=Events.drawLootRow(t,i),o.insertBefore($(".takeETrow",e)));Player.inventory[t]-=i;Events.getLoot(s);Player.updateSupplies()},getLoot:function(n,t){var u=n.attr("id").substring(5).replace("-"," "),r,i;if(n.data("numLeft")>0){var t=t||!1,f=Items.getWeight(u),e=Player.getFreeSpace();f<=e&&(r=n.data("numLeft"),r--,n.data("numLeft",r),n.text(u+" ["+r+"]"),r===0&&(Button.setDisabled(n),n.animate({opacity:0},300,"linear",function(){$(this).parent().remove();$("#lootButtons").children().length==1&&$("#lootButtons").remove()})),i=Player.inventory[u],i=typeof i=="number"?i:0,i++,Player.inventory[u]=i,Player.updateSupplies(),t||Events.setTakeAll());t||Events.drawDrop(n)}},takeAll:function(n){for(var i=$("#"+n.attr("id").substring(4)),t=0;t<n.data("numLeft");t++)Events.getLoot(i,!0);Events.setTakeAll()},takeEverything:function(n){$("#lootButtons").children(".lootRow").each(function(){var n=$(this).children(".lootTakeAll").first();n.hasClass("disabled")||Events.takeAll(n)});n.data("canLeave")&&n.data("leaveBtn").click()},createCombatPanel:function(n,t){var i=$("<div>").attr("id","combatPanel").appendTo(n),r;Events.createFighterStatsDiv("Player",Player.health,Player.getMaxHealth()).attr("id","gamePlayerStats").appendTo(i);r=$("<div>").attr("id","fightersPanel").appendTo(i);Events.createFighterDiv("Player").attr("id","gamePlayer").appendTo(r);Events.createFighterDiv(t.enemyName).attr("id","gameEnemy").appendTo(r);Events.createFighterStatsDiv(t.enemyName,t.health,t.health).attr("id","gameEnemyStats").appendTo(i)},createFighterDiv:function(n){return $("<div>").addClass("fighter").html("<i class='fa fa-male fa-3x'><\/i><br />"+n)},createFighterStatsDiv:function(n,t,i){var r=$("<div>").addClass("fighterStats").data("hp",t).data("maxHp",i).data("refname",n);return $("<span>").addClass("fighterStatsName").text(n).appendTo(r),$("<div>").addClass("hp").text(t+"/"+i).appendTo(r),r},updateFighterDiv:function(n){$(".hp",n).text(n.data("hp")+"/"+n.data("maxHp"))},drawButtons:function(n){var f=$("#eventButtons",Events.eventPanel()),r=[],u,t,i;for(u in n.buttons)t=n.buttons[u],i=new Button.Button({id:u,text:t.text,cost:t.cost,click:Events.buttonClick,cooldown:t.cooldown}).appendTo(f),typeof t.available!="function"||t.available()||Button.setDisabled(i,!0),typeof t.cooldown=="number"&&Button.cooldown(i),r.push(i);return Events.updateButtons(),r.length==1?r[0]:!1},updateButtons:function(){var e=Events.activeEvent().scenes[Events.activeScene].buttons,i,n,r,u,f,t;for(i in e)if(n=e[i],r=$("#"+i,Events.eventPanel()),typeof n.available!="function"||n.available()){if(n.cost){u=!1;for(f in n.cost)if(t=Player.inventory[f],typeof t!="number"&&(t=0),t<n.cost[f]){u=!0;break}Button.setDisabled(r,u)}}else Button.setDisabled(r,!0)},buttonClick:function(n){var t=Events.activeEvent().scenes[Events.activeScene].buttons[n.attr("id")],e={},r,u,o,s,h,i,f;if(t.cost){for(r in t.cost){if(u=Player.inventory[r],typeof u!="number"&&(u=0),u<t.cost[r])return;e[r]=-t.cost[r]}for(o in e)Player.inventory[o]+=e[o];Player.updateSupplies()}if(typeof t.onChoose=="function"){s=Events.eventPanel().find("textarea");t.onChoose(s.length>0?s.val():null)}if(t.reward&&$SM.addM("stores",t.reward),Events.updateButtons(),t.notification&&Notifications.notify(null,t.notification),t.nextScene)if(t.nextScene=="end")Events.endEvent();else{h=Math.random();i=null;for(f in t.nextScene)h<f&&(i==null||f<i)&&(i=f);if(i!=null){Events.loadScene(t.nextScene[i]);return}Engine.log("ERROR: no suitable scene found");Events.endEvent()}},triggerEvent:function(){var n,i,t,r;if(Events.activeEvent()==null){n=[];for(i in Events.EventPool)t=Events.EventPool[i],t.isAvailable()&&n.push(t);if(n.length===0){Events.scheduleNextEvent(.5);return}r=Math.floor(Math.random()*n.length);Events.startEvent(n[r])}Events.scheduleNextEvent()},triggerFight:function(){var n=[],i,t,r;for(i in Events.Encounters)t=Events.Encounters[i],t.isAvailable()&&n.push(t);r=Math.floor(Math.random()*n.length);Events.startEvent(n[r])},startEvent:function(n,t){if(n){Engine.event("game event","event");Engine.keyLock=!0;Engine.tabNavigation=!1;Button.saveCooldown=!1;Events.eventStack.unshift(n);n.eventPanel=$("<div>").attr("id","event").addClass("eventPanel").css("opacity","0");t!=null&&t.width!=null&&Events.eventPanel().css("width",t.width);$("<div>").addClass("eventTitle").text(Events.activeEvent().title).appendTo(Events.eventPanel());$("<div>").attr("id","eventDescription").appendTo(Events.eventPanel());$("<div>").attr("id","eventButtons").appendTo(Events.eventPanel());Events.loadScene("start");$("div#gameWrapper").append(Events.eventPanel());Events.eventPanel().animate({opacity:1},Events._PANEL_FADE,"linear");var i=Events.activeEvent().scenes[Events.activeScene]}},scheduleNextEvent:function(n){var t=Math.floor(Math.random()*(Events._EVENT_TIME_RANGE[1]-Events._EVENT_TIME_RANGE[0]))+Events._EVENT_TIME_RANGE[0];n>0&&(t*=n);Engine.log("next event scheduled in "+t+" minutes");Events._eventTimeout=Engine.setTimeout(Events.triggerEvent,t*6e4)},endEvent:function(){Events.eventPanel().animate({opacity:0},Events._PANEL_FADE,"linear",function(){Events.eventPanel().remove();Events.activeEvent().eventPanel=null;Events.eventStack.shift();Engine.log(Events.eventStack.length+" events remaining");Engine.keyLock=!1;Engine.tabNavigation=!0;Button.saveCooldown=!0;$("body").focus()})},handleStateUpdates:function(n){n.category=="stores"&&Events.activeEvent()!=null&&Events.updateButtons()},initDelay:function(){$SM.get(Events.delayState)&&Events.recallDelay(Events.delayState,Events)},recallDelay:function(n,t){var r=$SM.get(n);for(var i in r)typeof r[i]=="object"?Events.recallDelay(n+'["'+i+'"]',t[i]):typeof t[i]=="function"?t[i]():$SM.remove(n);$.isEmptyObject(r)&&$SM.remove(n)},saveDelay:function(n,t,i){var r=Events.delayState+"."+t,i,u;i?$SM.set(r,i):i=$SM.get(r,!0);u=Engine.setInterval(function(){$SM.set(r,$SM.get(r)-.5,!0)},500);Engine.setTimeout(function(){window.clearInterval(u);$SM.remove(r);$SM.removeBranch(Events.delayState);n()},i*1e3)}},Items={Weapons:{fists:{verb:"punch",type:"unarmed",damage:1,cooldown:2},"bone spear":{verb:"stab",type:"melee",damage:2,cooldown:2},"iron sword":{verb:"swing",type:"melee",damage:4,cooldown:2},rifle:{verb:"shoot",type:"ranged",damage:5,cooldown:1,cost:{bullets:1}}},Craftables:{torch:{name:"torch",type:"tool",buildMsg:"a torch to keep the dark away",cost:function(){return{wood:1,cloth:1}}},"bone spear":{name:"bone spear",type:"weapon",buildMsg:"this spear's not elegant, but it's pretty good at stabbing",cost:function(){return{wood:2,bone:1}}}},TradeGoods:{medicine:{type:"good",cost:function(){return{money:10}}},bullets:{type:"good",cost:function(){return{money:5}}}},MiscItems:{"laser rifle":{name:"Laser Rifle",type:"weapon",weight:5},"tv remote":{name:"TV Remote",type:"misc",weight:1}},init:function(n){this.options=$.extend(this.options,n);$.Dispatch("stateUpdate").subscribe(Items.handleStateUpdates)},options:{},getWeight:function(n){return n.weight?n.weight:1},createItemDiv:function(n,t){return $("<div>").attr("id","supply_"+n.replace(" ","-")).addClass("supplyItem").text(n+":"+t)},handleStateUpdates:function(){}},Notifications={init:function(n){this.options=$.extend(this.options,n);elem=$("<div>").attr({id:"gameNotifications",className:"notifications"});$("<div>").attr("id","notifyGradient").appendTo(elem);elem.appendTo("#gameMain")},options:{},elem:null,notifyQueue:{},notify:function(n,t,i){typeof n!="undefined"&&(t!=null&&Engine.activeRoom!=t?i||(typeof this.notifyQueue[t]=="undefined"&&(this.notifyQueue[t]=[]),this.notifyQueue[t].push(n)):Notifications.printMessage(n),Engine.saveGame())},clearHidden:function(){var n=$("#notifyGradient").position().top+$("#notifyGradient").outerHeight(!0);$(".notification").each(function(){$(this).position().top>n&&$(this).remove()})},printMessage:function(n){var t=$("<div>").addClass("notification").css("opacity","0").html(n).prependTo("div#gameNotifications");t.animate({opacity:1},500,"linear",function(){Notifications.clearHidden()})},printQueue:function(n){if(typeof this.notifyQueue[n]!="undefined")while(this.notifyQueue[n].length>0)Notifications.printMessage(this.notifyQueue[n].shift())}},Player={BASE_HEALTH:10,BASE_HIT_CHANCE:.8,DEFAULT_BAG_SPACE:10,MEDS_HEAL:20,name:"Player",options:{},init:function(n){var t,i,r,u;this.options=$.extend(this.options,n);t=$SM.get("player.health");t==undefined&&(t=Player.getMaxHealth());Player.setHp(t);Player.inventory=$SM.get("inventory");i=$("<div>").attr("id","gamePlayerHeaderPanel").appendTo("#gameHeader");$("<span>").addClass("gamePlayerHeaderTitle").text("Player").appendTo(i);r=$("<div>").attr("id","gamePlayerHeaderStats").appendTo(i);$("<div>").attr("id","gamePlayerHeaderHealthCounter").html("HP: "+Player.health+"/"+Player.getMaxHealth()).appendTo(r);$("<div>").attr("id","gamePlayerHeaderInventorySpace").html("Inventory Space: "+Player.getFreeSpace()+"/"+Player.getCapacity()).appendTo(r);u=$("<div>").attr("id","gamePlayerHeaderInventory").appendTo(i);$.Dispatch("stateUpdate").subscribe(Player.handleStateUpdates)},updatePerks:function(){var i,u,n,r,t;if($SM.get("character.perks")){i=$("#perks");u=!1;i.length===0&&(u=!0,i=$("<div>").attr({id:"perks","data-legend":"perks:"}));for(n in $SM.get("character.perks"))r="perk_"+n.replace(" ","-"),t=$("#"+r),$SM.get('character.perks["'+n+'"]')&&t.length===0&&(t=$("<div>").attr("id",r).addClass("perkRow").appendTo(i),$("<div>").addClass("row_key").text(_(n)).appendTo(t),$("<div>").addClass("tooltip bottom right").text(Engine.Perks[n].desc).appendTo(t))}},updatePlayerStats:function(){$("#gamePlayerHeaderHealthCounter").html("HP: "+Player.health+"/"+Player.getMaxHealth());$("#gamePlayerHeaderInventorySpace").html("Inventory Space: "+Player.getFreeSpace()+"/"+Player.getCapacity()).appendTo(playerStats)},updateInventory:function(){var i=$("div#inventory"),t,n;Player.inventory||(Player.inventory={});t=Path.getFreeSpace();n=0;$("#bagspace").text(_("free {0}/{1}",Math.floor(Player.getCapacity()-n),Player.getCapacity()))},updateSupplies:function(){},getFreeSpace:function(){var i=0,n,t;if(Player.inventory)for(n in Player.inventory)t=Player.inventory[n],isNaN(t)&&(Player.inventory[n]=t=0),i+=t*Items.getWeight(n);return Player.getCapacity()-i},getCapacity:function(){return $SM.get("stores.rucksack",!0)>0?Player.DEFAULT_BAG_SPACE+10:Player.DEFAULT_BAG_SPACE},setHp:function(n){typeof n!="number"||isNaN(n)||(Player.health=n,Player.health>Player.getMaxHealth()&&(Player.health=Player.getMaxHealth()),$SM.set("player.health",Player.health))},medsHeal:function(){return World.MEDS_HEAL},die:function(){Player.dead||(Player.dead=!0,Engine.log("player death"),Engine.event("game event","death"),Engine.keyLock=!0,Notifications.notify("You Died!"),Engine.GAME_OVER=!0,Engine.setTimeout(function(){Engine.endGame()},2e3,!0))},getMaxHealth:function(){return $SM.get('stores["s armour"]',!0)>0?Player.BASE_HEALTH+35:$SM.get('stores["i armour"]',!0)>0?Player.BASE_HEALTH+15:$SM.get('stores["l armour"]',!0)>0?Player.BASE_HEALTH+5:Player.BASE_HEALTH},getHitChance:function(){return $SM.hasPerk("hawkeye")?Player.BASE_HIT_CHANCE+.1:Player.BASE_HIT_CHANCE},handleStateUpdates:function(n){n.category=="character"&&n.stateName.indexOf("character.perks")===0&&Player.updatePerks();n.category=="player"&&(n.stateName.indexOf("player.health")===0||n.stateName.indexOf("inventory")===0)&&Player.updatePlayerStats()}},StateManager={MAX_STORE:99999999999999,options:{},init:function(n){var t,i;this.options=$.extend(this.options,n);t=["features","stores","inventory","player","timers","game","playStats","calldown","story"];for(i in t)$SM.get(t[i])||$SM.set(t[i],{});$.Dispatch("stateUpdate").subscribe($SM.handleStateUpdates)},createState:function(n,t){for(var r,f,e,u=n.split(/[.\[\]'"]+/),i=0;i<u.length;i++)u[i]===""&&(u.splice(i,1),i--);for(r=State,f=null,i=0,e=u.length-1;i<e;i++)f=u[i],r[f]===undefined&&(r[f]={}),r=r[f];return r[u[i]]=t,r},set:function(n,t,i){var r=$SM.buildPath(n);typeof t=="number"&&t>$SM.MAX_STORE&&(t=$SM.MAX_STORE);try{eval("("+r+") = value")}catch(u){$SM.createState(n,t)}n.indexOf("stores")===0&&$SM.get(n,!0)<0&&(eval("("+r+") = 0"),Engine.log("WARNING: state:"+n+" can not be a negative value. Set to 0 instead."));i||(Engine.saveGame(),$SM.fireUpdate(n))},setM:function(n,t,i){$SM.buildPath(n);$SM.get(n)===undefined&&$SM.set(n,{},!0);for(var r in t)$SM.set(n+'["'+r+'"]',t[r],!0);i||(Engine.saveGame(),$SM.fireUpdate(n))},add:function(n,t,i){var u=0,r=$SM.get(n,!0);return r!=r?(Engine.log("WARNING: "+n+" was corrupted (NaN). Resetting to 0."),r=0,$SM.set(n,r+t,i)):typeof r!="number"||typeof t!="number"?(Engine.log("WARNING: Can not do math with state:"+n+" or value:"+t+" because at least one is not a number."),u=1):$SM.set(n,r+t,i),u},addM:function(n,t,i){var u=0,r;$SM.get(n)===undefined&&$SM.set(n,{},!0);for(r in t)$SM.add(n+'["'+r+'"]',t[r],!0)&&u++;return i||(Engine.saveGame(),$SM.fireUpdate(n)),u},get:function(n,t){var i=null,r=$SM.buildPath(n);try{eval("whichState = ("+r+")")}catch(u){i=undefined}return(!i||i=={})&&t?0:i},setget:function(n,t,i){return $SM.set(n,t,i),eval("("+$SM.buildPath(n)+")")},remove:function(n,t){var i=$SM.buildPath(n);try{eval("(delete "+i+")")}catch(r){Engine.log("WARNING: Tried to remove non-existant state '"+n+"'.")}t||(Engine.saveGame(),$SM.fireUpdate(n))},removeBranch:function(n,t){for(var i in $SM.get(n))typeof $SM.get(n)[i]=="object"&&$SM.removeBranch(n+'["'+i+'"]');$.isEmptyObject($SM.get(n))&&$SM.remove(n);t||(Engine.saveGame(),$SM.fireUpdate(n))},buildPath:function(n){var t=n.charAt(0)=="["?"":".";return"State"+t+n},fireUpdate:function(n,t){var i=$SM.getCategory(n);n==undefined&&(n=i="all");$.Dispatch("stateUpdate").publish({category:i,stateName:n});t&&Engine.saveGame()},getCategory:function(n){var t=n.indexOf("["),i=n.indexOf("."),r=null;return r=t==-1||i==-1?t>i?t:i:t<i?t:i,r==-1?n:n.substr(0,r)},updateOldState:function(){var n=$SM.get("version");typeof n!="number"&&(n=1)},addPerk:function(n){$SM.set('player.perks["'+n+'"]',!0);Notifications.notify(null,Engine.Perks[n].notify)},hasPerk:function(n){return $SM.get('player.perks["'+n+'"]')},handleStateUpdates:function(){}},$SM=StateManager,Story={START_ROOM:"test",activeRoom:null,init:function(n){var t,i;this.options=$.extend(this.options,n);t=$SM.get("story.room");t==undefined&&(t=Story.setDefaultRoom());Story.setRoom(t);i=$("<div>").attr("id","gameStoryHeaderPanel").appendTo("#gameHeader");$("<span>").addClass("gameStoryHeaderLocation").text("Location: "+Story.activeRoom).appendTo(i);$.Dispatch("stateUpdate").subscribe(Story.handleStateUpdates)},setRoom:function(n){n!==undefined&&(Story.activeRoom=n)},setDefaultRoom:function(){return $SM.set("story.room",Story.START_ROOM),Story.START_ROOM},handleStateUpdates:function(n){n.category=="story"&&n.stateName.indexOf("story.room")===0&&Story.setRoom($SM.get("story.room"))}};Events.Encounters=[{title:"Combat - Archie",isAvailable:function(){return!0},scenes:{start:{combat:!0,enemy:"archie",enemyName:"Archie",deathMessage:"Archie is dead",damage:1,hit:.5,attackDelay:2,health:3,loot:{"tv remote":{itemObj:Items.MiscItems["tv remote"],min:1,max:1,chance:1}},notification:"A wild Archie runs at you with arms help high"}}}];